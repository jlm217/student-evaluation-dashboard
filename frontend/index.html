<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Evaluation Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .theme-button.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .prose h3 {
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .prose p {
            margin-bottom: 0.5em;
        }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1em;
        }
        .comment-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .comment-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .spinner {
            border: 2px solid #e2e8f0;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .results {
            display: none;
        }
        .upload-section {
            display: block;
        }
        .btn {
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-right: 12px;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #7c3aed;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #6d28d9;
            transform: translateY(-1px);
        }
        .btn:disabled {
            background-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .file-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin: 8px 0;
        }
        .success {
            color: #059669;
            font-size: 0.875rem;
            margin-top: 4px;
        }
        .error {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 4px;
        }
        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 32px;
        }
        
        /* Progress Tracker Styles */
        .progress-tracker {
            display: none;
        }
        .progress-step {
            position: relative;
            padding-left: 60px;
        }
        .step-icon {
            position: absolute;
            left: 0;
            top: 0;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            z-index: 2;
        }
        .step-icon.pending {
            background: #f3f4f6;
            color: #9ca3af;
            border: 2px solid #e5e7eb;
        }
        .step-icon.in_progress {
            background: #dbeafe;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            animation: pulse 2s infinite;
        }
        .step-icon.complete {
            background: #dcfce7;
            color: #16a34a;
            border: 2px solid #16a34a;
        }
        .step-icon.error {
            background: #fef2f2;
            color: #dc2626;
            border: 2px solid #dc2626;
        }
        .step-content {
            margin-left: 16px;
            padding-top: 8px;
        }
        .step-connector {
            position: absolute;
            left: 23px;
            top: 48px;
            width: 2px;
            height: 40px;
            background: #e5e7eb;
            transition: background-color 0.3s ease;
        }
        .step-connector.active {
            background: #16a34a;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .data-flow-animation {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
        }
        
        /* Batch Progress Styles */
        .batch-progress {
            margin-top: 8px;
            padding-left: 4px;
        }
        
        /* Chatbot Styles */
        .chat-fab {
            position: fixed;
            top: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .chat-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(79, 70, 229, 0.6);
        }
        
        .chat-fab.chat-open {
            background: #6b7280;
        }
        
        .chat-panel {
            position: fixed;
            top: 100px;
            right: 24px;
            width: 400px;
            height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            z-index: 999;
            transform: translateY(-20px) scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: auto;
            min-width: 350px;
            min-height: 400px;
            max-width: 600px;
            max-height: 80vh;
            cursor: move;
        }
        
        /* Custom resize handle positioned at bottom-left center */
        .chat-panel::before {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: linear-gradient(-45deg, transparent 40%, #cbd5e1 40%, #cbd5e1 60%, transparent 60%);
            cursor: nw-resize;
            z-index: 1000;
            border-radius: 3px;
        }
        
        /* Hide default webkit resizer */
        .chat-panel::-webkit-resizer {
            display: none;
        }
        
        .chat-panel.open {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 16px 20px;
            border-radius: 16px 16px 0 0;
            display: flex;
            align-items: center;
            justify-content: between;
            cursor: grab;
            user-select: none;
        }
        
        .chat-header:active {
            cursor: grabbing;
        }
        
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        
        .chat-message {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
        }
        
        .chat-message.user {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message-bubble.user {
            background: #4f46e5;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-bubble.assistant {
            background: #f3f4f6;
            color: #374151;
            border-bottom-left-radius: 4px;
        }
        
        /* Markdown styling for assistant messages */
        .message-bubble.assistant h1,
        .message-bubble.assistant h2,
        .message-bubble.assistant h3,
        .message-bubble.assistant h4 {
            font-weight: 600;
            margin: 8px 0 4px 0;
            line-height: 1.3;
        }
        
        .message-bubble.assistant h3 {
            font-size: 1em;
        }
        
        .message-bubble.assistant p {
            margin: 4px 0;
            line-height: 1.4;
        }
        
        .message-bubble.assistant ul,
        .message-bubble.assistant ol {
            margin: 4px 0;
            padding-left: 16px;
        }
        
        .message-bubble.assistant li {
            margin: 2px 0;
        }
        
        .message-bubble.assistant strong {
            font-weight: 600;
        }
        
        .message-bubble.assistant em {
            font-style: italic;
        }
        
        .message-bubble.assistant code {
            background: #e5e7eb;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .chat-input-container {
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 16px 16px;
            background: white;
        }
        
        .chat-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            resize: none;
        }
        
        .chat-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        
        .send-button {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .send-button:hover:not(:disabled) {
            background: #4338ca;
        }
        
        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #6b7280;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .typing-dots {
            display: flex;
            gap: 2px;
        }
        
        .typing-dot {
            width: 4px;
            height: 4px;
            background: #6b7280;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        
        /* Batch Summary Styles */
        .batch-summary {
            margin-top: 8px;
            padding-left: 4px;
        }
        
        .batch-summary .text-xs {
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        @keyframes fadeInSlide {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0px);
            }
        }
        
        .batch-summary {
            min-height: 80px;
            position: relative;
            overflow: hidden;
        }
        
        .batch-summary-container {
            position: relative;
            min-height: 80px;
            overflow: hidden;
        }
        
        .batch-summary-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25px;
            background: linear-gradient(to bottom, transparent, rgba(238, 242, 255, 0.9));
            pointer-events: none;
        }
        
        .batch-summary-text {
            transition: opacity 0.3s ease-in-out;
            line-height: 1.3;
            word-wrap: break-word;
        }
        
        .batch-summary-animate {
            animation: fadeInSlide 0.5s ease-out;
        }
        .batch-progress.hidden {
            display: none;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Student Evaluation Analysis Dashboard</h1>
            <p class="text-lg text-gray-600 mt-1">Upload course data to analyze student feedback and performance.</p>
        </header>

        <!-- Upload Section -->
        <div class="card upload-section" id="upload-section">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Upload Your Data</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Comments File (Required) -->
                <div class="flex flex-col">
                    <label for="comments-file" class="font-medium text-gray-700 mb-2">
                        <i class="fas fa-comments mr-2 text-indigo-500"></i>Student Comments File *
                    </label>
                    <input type="file" id="comments-file" accept=".csv" class="file-input" required>
                    <div id="comments-status" class="text-sm"></div>
                    <p class="text-xs text-gray-500 mt-1">Required: CSV with question/response columns</p>
                </div>
                <!-- Schedule File (Optional) -->
                <div class="flex flex-col">
                    <label for="schedule-file" class="font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-2 text-green-500"></i>Course Schedule File
                    </label>
                    <input type="file" id="schedule-file" accept=".csv" class="file-input">
                    <div id="schedule-status" class="text-sm"></div>
                    <p class="text-xs text-gray-500 mt-1">Optional: Course section details</p>
                </div>
                <!-- Grades File (Optional) -->
                <div class="flex flex-col">
                    <label for="grades-file" class="font-medium text-gray-700 mb-2">
                        <i class="fas fa-graduation-cap mr-2 text-amber-500"></i>Grades & Enrollment File
                    </label>
                    <input type="file" id="grades-file" accept=".csv" class="file-input">
                    <div id="grades-status" class="text-sm"></div>
                    <p class="text-xs text-gray-500 mt-1">Optional: Grade distribution data</p>
                </div>
                <!-- Likert File (Optional) -->
                <div class="flex flex-col">
                    <label for="likert-file" class="font-medium text-gray-700 mb-2">
                        <i class="fas fa-chart-line mr-2 text-purple-500"></i>Survey Data (Likert)
                    </label>
                    <input type="file" id="likert-file" accept=".csv" class="file-input">
                    <div id="likert-status" class="text-sm"></div>
                    <p class="text-xs text-gray-500 mt-1">Optional: Quantitative survey responses</p>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-4">
                <button class="btn btn-secondary" onclick="tryDemo()">
                    <i class="fas fa-play mr-2"></i>Try Demo
                </button>
                <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeFiles()" disabled>
                    <i class="fas fa-cogs mr-2"></i>Analyze & Build Dashboard
                </button>
            </div>
        </div>

        <!-- Loading Section -->
        <div class="card loading" id="loading">
            <div class="spinner"></div>
            <span style="font-size: 1.1rem; color: #374151;">Processing your data...</span>
            <p class="text-sm text-gray-600 mt-2">This may take a few minutes depending on the size of your data.</p>
        </div>

        <!-- Progress Tracker Section -->
        <div class="card progress-tracker" id="progress-tracker" style="display: none;">
            <div class="mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-2">
                    <i class="fas fa-cogs mr-2 text-indigo-500"></i>Analysis in Progress
                </h2>
                <p class="text-gray-600">Please wait while we process your data through our analysis pipeline...</p>
            </div>

            <!-- Progress Steps -->
            <div class="space-y-6">
                <!-- Step 1: Cleaning -->
                <div class="progress-step" id="step-cleaning">
                    <div class="flex items-center">
                        <div class="step-icon pending" id="icon-cleaning">
                            <i class="fas fa-broom"></i>
                        </div>
                        <div class="step-content">
                            <h3 class="font-semibold text-gray-800">Cleaning & Preparing Data</h3>
                            <p class="text-sm text-gray-600" id="msg-cleaning">Validating and formatting your uploaded files...</p>
                        </div>
                    </div>
                    <div class="step-connector" id="connector-cleaning"></div>
                </div>

                <!-- Step 2: Coding -->
                <div class="progress-step" id="step-coding">
                    <div class="flex items-center">
                        <div class="step-icon pending" id="icon-coding">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="step-content">
                            <h3 class="font-semibold text-gray-800">Generating Initial Codes & Sentiment</h3>
                            <p class="text-sm text-gray-600" id="msg-coding">AI-powered analysis of student responses...</p>
                        </div>
                    </div>
                    <div class="step-connector" id="connector-coding"></div>
                </div>

                <!-- Step 3: Themes -->
                <div class="progress-step" id="step-themes">
                    <div class="flex items-center">
                        <div class="step-icon pending" id="icon-themes">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="step-content">
                            <h3 class="font-semibold text-gray-800">Synthesizing Themes</h3>
                            <p class="text-sm text-gray-600" id="msg-themes">Identifying patterns and key insights...</p>
                        </div>
                    </div>
                    <div class="step-connector" id="connector-themes"></div>
                </div>

                <!-- Step 3.5: Quantitative (Conditional) -->
                <div class="progress-step hidden" id="step-quantitative">
                    <div class="flex items-center">
                        <div class="step-icon pending" id="icon-quantitative">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="step-content">
                            <h3 class="font-semibold text-gray-800">Processing Quantitative Survey Data</h3>
                            <p class="text-sm text-gray-600" id="msg-quantitative">Analyzing survey responses and calculating peer benchmarks...</p>
                        </div>
                    </div>
                    <div class="step-connector" id="connector-quantitative"></div>
                </div>

                <!-- Step 4: Summary -->
                <div class="progress-step" id="step-summary">
                    <div class="flex items-center">
                        <div class="step-icon pending" id="icon-summary">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="step-content">
                            <h3 class="font-semibold text-gray-800">Generating Executive Summary</h3>
                            <p class="text-sm text-gray-600" id="msg-summary">Creating comprehensive analysis report...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dynamic Progress and Summary Container -->
            <div class="mt-8">
                <!-- Batch Progress Display -->
                <div class="batch-progress hidden" id="batch-progress-coding">
                    <div class="text-center mb-4">
                        <div class="text-sm text-indigo-600 font-medium mb-2" id="batch-text-coding"></div>
                        <div class="w-full bg-gray-200 rounded-full h-2 max-w-md mx-auto">
                            <div class="bg-indigo-600 h-2 rounded-full transition-all duration-300" id="batch-bar-coding" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Batch Summary Display -->
                <div class="batch-summary" id="batch-summary-coding">
                    <div class="max-w-2xl mx-auto">
                        <div class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-200">
                            <div class="batch-summary-container">
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-lightbulb text-indigo-500 mt-1 flex-shrink-0"></i>
                                    <div class="text-sm text-indigo-800 font-medium batch-summary-text" id="batch-summary-text-coding">
                                        <!-- Summary text will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Default animation when no batch activity -->
                <div class="data-flow-animation" id="default-animation">
                    <svg class="w-full h-16" viewBox="0 0 400 64">
                        <!-- Background track -->
                        <line x1="50" y1="32" x2="350" y2="32" stroke="#e5e7eb" stroke-width="2"/>
                        
                        <!-- Animated flow -->
                        <circle id="data-flow-dot" cx="50" cy="32" r="4" fill="#4f46e5" opacity="0">
                            <animate attributeName="cx" values="50;350" dur="3s" repeatCount="indefinite"/>
                            <animate attributeName="opacity" values="0;1;1;0" dur="3s" repeatCount="indefinite"/>
                        </circle>
                        
                        <!-- Data points -->
                        <g id="data-points">
                            <circle cx="100" cy="32" r="2" fill="#10b981" opacity="0.6"/>
                            <circle cx="150" cy="32" r="2" fill="#f59e0b" opacity="0.6"/>
                            <circle cx="200" cy="32" r="2" fill="#ef4444" opacity="0.6"/>
                            <circle cx="250" cy="32" r="2" fill="#8b5cf6" opacity="0.6"/>
                            <circle cx="300" cy="32" r="2" fill="#06b6d4" opacity="0.6"/>
                        </g>
                    </svg>
                    <div class="text-center text-sm text-gray-500 mt-2">
                        <i class="fas fa-database mr-1"></i>
                        Processing your data through our analysis pipeline
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Dashboard -->
        <div id="dashboard-content" class="space-y-8 results">
            <h2 class="text-2xl font-semibold mb-0 text-gray-800">Explore the Analysis</h2>

            <!-- Course Section Filter and Details -->
            <div class="space-y-6">
                <!-- Course Section Filter -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 class="font-bold text-xl mb-4 text-gray-900">
                        <i class="fas fa-filter mr-2 text-blue-500"></i>Course Section Filter
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
                        <div class="lg:col-span-3">
                            <select id="section-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="all">All Sections</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <button id="executive-summary-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                                <i class="fas fa-file-alt mr-2"></i>View Executive Summary
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Course Details Card -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 class="font-bold text-xl mb-4 text-gray-900">
                        <i class="fas fa-info-circle mr-2 text-indigo-500"></i>Course Details
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm" id="course-details">
                        <!-- HIDDEN: Instructor details -->
                        <!--
                        <div class="text-center">
                            <div class="text-2xl font-bold text-indigo-600" id="detail-instructor">-</div>
                            <div class="text-gray-600">Instructor</div>
                        </div>
                        -->
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="detail-modality">-</div>
                            <div class="text-gray-600">Modality</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="detail-term">-</div>
                            <div class="text-gray-600">Term</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600" id="detail-enrollment">-</div>
                            <div class="text-gray-600">Enrollment</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quantitative Survey Results and Grade Distribution -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Quantitative Survey Results (Conditional) -->
                <div id="quantitative-results-container" class="bg-white rounded-xl shadow-md border border-gray-200 hidden">
                    <button id="toggle-quantitative" class="w-full text-left p-4 font-semibold text-lg text-gray-800 flex justify-between items-center hover:bg-gray-50 transition-colors">
                        <span><i class="fas fa-chart-bar mr-3 text-purple-500"></i>Quantitative Survey Results</span>
                        <i id="quantitative-chevron" class="fas fa-chevron-down transition-transform"></i>
                    </button>
                    <div id="quantitative-content" class="px-6 pb-6 border-t border-gray-200 hidden">
                        <div id="quantitative-charts-wrapper" class="space-y-6 max-h-96 overflow-y-auto pr-2" style="scrollbar-width: thin;">
                            <!-- Dynamic charts will be inserted here -->
                        </div>
                        <div id="no-quantitative-data" class="text-center py-8 text-gray-500 hidden">
                            <i class="fas fa-info-circle text-3xl mb-3"></i>
                            <p class="text-lg">No quantitative survey data available for this section.</p>
                            <p class="text-sm">Upload a Likert survey data file to see quantitative insights.</p>
                        </div>
                    </div>
                </div>

                <!-- Grade Distribution Chart -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h3 class="font-bold text-xl mb-4 text-gray-900">
                        <i class="fas fa-chart-line mr-2 text-green-500"></i>Grade Distribution
                    </h3>
                    <div class="h-48 flex items-center justify-center">
                        <canvas id="gradeChart" class="max-w-full max-h-full"></canvas>
                        <div id="no-grade-data" class="text-gray-500 text-center hidden">
                            <i class="fas fa-info-circle text-2xl mb-2"></i>
                            <p>No grade data available</p>
                        </div>
                    </div>
                    <!-- DEW Rate Display -->
                    <div id="dew-stats" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                <span class="font-semibold text-red-800">DEW Rate:</span>
                            </div>
                            <div class="text-right">
                                <span id="dew-percentage" class="font-bold text-red-800 text-lg">-</span>
                                <span class="text-red-600 ml-2">(<span id="dew-breakdown" class="text-sm">-</span>)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thematic Summary -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-xl text-gray-900">
                        <i class="fas fa-chart-pie mr-2 text-blue-500"></i>Thematic Summary
                    </h3>
                    <button id="analysis-memo-btn-thematic" class="text-gray-400 hover:text-indigo-600 transition-colors text-sm" title="View AI Analysis Memo">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
                <div class="max-h-80 overflow-y-auto" id="thematic-summary">
                    <!-- Thematic data will be populated here -->
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                        <div class="text-center">
                            <div class="font-semibold text-gray-800" id="total-comments">-</div>
                            <div>Total Comments</div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold text-gray-800" id="total-themes">-</div>
                            <div>Themes Found</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Feedback Module -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h3 class="font-bold text-xl text-gray-900">
                        <i class="fas fa-comments mr-2 text-blue-500"></i>Student Feedback
                    </h3>
                    <button class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors text-sm" onclick="downloadThemedCSV()">
                        <i class="fas fa-download mr-2"></i>Download Themed CSV
                    </button>
                </div>
                
                <!-- Keyword Search -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search comments by keyword..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                    </div>
                </div>

                <!-- Theme Filters -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-3">
                        <h4 class="font-semibold text-gray-700">Filter by Theme:</h4>
                        <button id="analysis-memo-btn" class="text-gray-400 hover:text-indigo-600 transition-colors text-sm" title="View AI Analysis Memo">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2" id="theme-filters">
                        <button class="theme-button active px-4 py-2 rounded-full font-semibold text-sm transition bg-gray-100 text-gray-700 hover:bg-gray-200" onclick="filterByTheme('all')">All Themes</button>
                        <!-- Theme buttons will be populated dynamically -->
                    </div>
                </div>

                <!-- Comments Display -->
                <div class="max-h-[60vh] overflow-y-auto space-y-4 pr-2" id="comments-container">
                    <!-- Comments will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- How does this work button (visible on all pages) -->
        <div id="methodology-button-container" class="fixed bottom-6 right-6">
            <button id="how-it-works-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition-all duration-200 ease-in-out transform hover:scale-105">
                <i class="fas fa-question-circle mr-2"></i>How does this work?
            </button>
        </div>
    </div>

    <!-- Methodology Overlay Modal -->
    <div id="methodology-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl max-h-[90vh] overflow-y-auto m-4">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Methodology Overview</h2>
                <button id="close-methodology" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="px-8 py-8 space-y-12">
                <!-- Introduction -->
                <div class="text-center">
                    <p class="text-gray-600 text-lg leading-relaxed max-w-3xl mx-auto">
                        Our methodology follows a systematic six-phase progression that transforms individual student comments into comprehensive strategic insights, with each phase building upon the previous to ensure reliable, actionable results.
                    </p>
                </div>

                <!-- Phase 0 -->
                <div class="bg-gray-50 rounded-lg p-8">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">Phase 0: Data Foundation</h3>
                    <p class="text-lg text-gray-600 mb-6 italic">Setting the stage for reliable analysis</p>
                    
                    <div class="space-y-4">
                        <div><strong class="text-gray-800">Harmonize formats:</strong> <span class="text-gray-700">Different data sources often use varying column names (like "Q1" vs "Question_1"). We standardize these automatically so nothing gets lost in translation.</span></div>
                        <div><strong class="text-gray-800">Polish the text:</strong> <span class="text-gray-700">Students sometimes use creative formatting, extra spaces, or special characters. We clean these up while preserving the authentic voice.</span></div>
                        <div><strong class="text-gray-800">Catch duplicates:</strong> <span class="text-gray-700">Sometimes the same response appears multiple times. We identify and remove these to ensure each student voice is counted once.</span></div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                        <p class="text-blue-800"><strong>Why this matters:</strong> Just like preparing ingredients before cooking, clean data ensures our AI analysis starts with the best possible foundation.</p>
                    </div>
                </div>

                <!-- Phase 1 -->
                <div class="bg-white rounded-lg p-8 border border-gray-200">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">Phase 1: Understanding Individual Voices</h3>
                    <p class="text-lg text-gray-600 mb-6 italic">Giving every comment a meaningful label</p>
                    
                    <div class="space-y-4">
                        <div><strong class="text-gray-800">Descriptive coding:</strong> <span class="text-gray-700">Our AI reads each student comment and assigns a short, descriptive code that captures the essence (like "Clear expectations" or "Heavy workload").</span></div>
                        <div><strong class="text-gray-800">Thoughtful batching:</strong> <span class="text-gray-700">Comments are processed in small groups of 20 to maintain consistency and quality.</span></div>
                        <div><strong class="text-gray-800">Smart efficiency:</strong> <span class="text-gray-700">After generating 30+ unique codes, the AI is prompted to reuse existing ones rather than creating redundant labels.</span></div>
                        <div><strong class="text-gray-800">Emotional context:</strong> <span class="text-gray-700">Every comment receives a sentiment analysis—Positive, Negative, or Neutral—to understand not just the topic, but how students felt about it.</span></div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
                        <p class="text-green-800"><strong>Outcome:</strong> Every student comment now has a meaningful label and emotional context, creating a structured foundation for deeper analysis.</p>
                    </div>
                </div>

                <!-- Phase 2 -->
                <div class="bg-gray-50 rounded-lg p-8">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">Phase 2: Discovering Broader Patterns</h3>
                    <p class="text-lg text-gray-600 mb-6 italic">From individual codes to meaningful themes</p>
                    
                    <div class="space-y-4">
                        <div><strong class="text-gray-800">Pattern recognition:</strong> <span class="text-gray-700">Similar codes are intelligently grouped into broader themes that tell a coherent story (like grouping "Clear rubrics," "Fair grading," and "Timely feedback" into "Assessment Practices").</span></div>
                        <div><strong class="text-gray-800">Frequency-weighted insights:</strong> <span class="text-gray-700">Themes that appear in many student responses carry more weight in the analysis, ensuring common concerns aren't overlooked.</span></div>
                        <div><strong class="text-gray-800">Evidence-based grouping:</strong> <span class="text-gray-700">The AI uses actual student quotes to understand nuances and ensure accurate theme development.</span></div>
                        <div><strong class="text-gray-800">Comprehensive coverage:</strong> <span class="text-gray-700">Every code finds a home in exactly one theme, ensuring no student feedback is lost or double-counted.</span></div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
                        <p class="text-green-800"><strong>Outcome:</strong> A focused set of themes that represent the full spectrum of student experiences, each backed by real student voices and frequency data.</p>
                    </div>
                </div>

                <!-- Phase 3 -->
                <div class="bg-white rounded-lg p-8 border border-gray-200">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">Phase 3: Quantifying Student Perceptions</h3>
                    <p class="text-lg text-gray-600 mb-6 italic">Making numbers meaningful through smart comparisons</p>
                    
                    <div class="space-y-4">
                        <div><strong class="text-gray-800">Contextual benchmarking:</strong> <span class="text-gray-700">Each section's survey scores are compared only to other sections that received the same questions—ensuring fair, apples-to-apples comparisons.</span></div>
                        <div><strong class="text-gray-800">Clear scoring:</strong> <span class="text-gray-700">Likert scale responses are converted to numeric values that reveal performance patterns.</span></div>
                        <div><strong class="text-gray-800">Meaningful comparisons:</strong> <span class="text-gray-700">Sections are identified as above or below average only when statistically meaningful patterns emerge.</span></div>
                        <div><strong class="text-gray-800">Visual distributions:</strong> <span class="text-gray-700">Interactive charts show exactly how students responded across the rating scale.</span></div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                        <p class="text-blue-800"><strong>Why this adds value:</strong> Quantitative data provides objective validation for what students expressed in their comments, helping you distinguish between individual concerns and systemic patterns.</p>
                    </div>
                </div>

                <!-- Phase 4 -->
                <div class="bg-gray-50 rounded-lg p-8">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">Phase 4: Connecting the Dots</h3>
                    <p class="text-lg text-gray-600 mb-6 italic">Bringing all data sources together</p>
                    
                    <div class="space-y-4">
                        <div><strong class="text-gray-800">Unified view:</strong> <span class="text-gray-700">Student comments, survey responses, and academic performance data are linked by section, creating a comprehensive picture.</span></div>
                        <div><strong class="text-gray-800">Academic context:</strong> <span class="text-gray-700">DEW rates (D, F, Withdrawal percentages) and grade distributions provide crucial context for interpreting feedback.</span></div>
                        <div><strong class="text-gray-800">Quality assurance:</strong> <span class="text-gray-700">The system automatically flags potential data mismatches or time period inconsistencies.</span></div>
                    </div>
                </div>

                <!-- Phase 5 -->
                <div class="bg-white rounded-lg p-8 border border-gray-200">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">Phase 5: Generating Strategic Insights</h3>
                    <p class="text-lg text-gray-600 mb-6 italic">AI-powered synthesis for actionable recommendations</p>
                    
                    <div class="space-y-4">
                        <div><strong class="text-gray-800">Holistic analysis:</strong> <span class="text-gray-700">The AI synthesizes qualitative themes, quantitative scores, and academic outcomes to identify the most significant patterns.</span></div>
                        <div><strong class="text-gray-800">Evidence-based storytelling:</strong> <span class="text-gray-700">Key insights are supported by actual student quotes, survey data, and performance metrics.</span></div>
                        <div><strong class="text-gray-800">Actionable priorities:</strong> <span class="text-gray-700">The summary highlights 2-3 specific areas where focused improvement efforts would likely have the greatest impact.</span></div>
                        <div><strong class="text-gray-800">Balanced perspective:</strong> <span class="text-gray-700">Both strengths and areas for growth are identified, providing a complete foundation for decision-making.</span></div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
                        <p class="text-green-800"><strong>Outcome:</strong> A comprehensive yet readable analysis that translates complex data into clear, actionable insights.</p>
                    </div>
                </div>

                <!-- Phase 6 -->
                <div class="bg-indigo-50 rounded-lg p-8 border-2 border-indigo-200">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">Phase 6: Interactive Data Exploration</h3>
                    <p class="text-lg text-indigo-700 mb-6 italic font-medium">Your personal data analyst at your fingertips</p>
                    
                    <div class="space-y-4">
                        <div><strong class="text-gray-800">Conversational interface:</strong> <span class="text-gray-700">An AI-powered chatbot lets you ask natural language questions about your data ("What did students say about workload?" or "How do online sections compare to in-person?").</span></div>
                        <div><strong class="text-gray-800">Contextual responses:</strong> <span class="text-gray-700">The chatbot maintains conversation history and provides detailed, evidence-based answers drawn exclusively from your data.</span></div>
                        <div><strong class="text-gray-800">Instant insights:</strong> <span class="text-gray-700">Get immediate answers to follow-up questions that emerge as you explore your results.</span></div>
                        <div><strong class="text-gray-800">Transparent sourcing:</strong> <span class="text-gray-700">Every response includes citations to specific data points, so you know exactly where insights come from.</span></div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-indigo-100 rounded-lg border-l-4 border-indigo-500">
                        <p class="text-indigo-800"><strong>Why this enhances your analysis:</strong> Instead of just reading a static report, you can actively explore your data, test hypotheses, and dive deeper into areas that matter most to your specific context.</p>
                    </div>
                </div>

                <!-- Dashboard Summary -->
                <div class="border-t-2 border-gray-300 pt-12">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-8 text-center">What You Can Explore on the Dashboard</h3>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">For Strategic Overview:</h4>
                            <ul class="space-y-3 text-gray-700">
                                <li><strong>Executive Summary:</strong> AI-generated synthesis of key findings with specific, actionable recommendations</li>
                                <li><strong>Thematic Analysis:</strong> Visual breakdown of student feedback topics with frequency, sentiment, and representative quotes</li>
                                <li><strong>Academic Performance:</strong> DEW rates and grade distributions providing outcome context</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">For Detailed Investigation:</h4>
                            <ul class="space-y-3 text-gray-700">
                                <li><strong>Section-by-section filters:</strong> Drill down into specific course sections to identify unique patterns or successful practices</li>
                                <li><strong>Quantitative benchmarks:</strong> Compare survey scores against peer sections with clear above/below average indicators</li>
                                <li><strong>Interactive data exploration:</strong> Ask the AI chatbot any questions about your data for instant, personalized insights</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">For Transparency and Validation:</h4>
                        <ul class="space-y-3 text-gray-700 max-w-4xl">
                            <li><strong>Methodology transparency:</strong> Full documentation of how AI decisions were made throughout the analysis</li>
                            <li><strong>Downloadable audit trail:</strong> Complete mapping from original comments through codes to final themes</li>
                            <li><strong>Data quality alerts:</strong> Automatic flags for any potential inconsistencies or limitations in your dataset</li>
                        </ul>
                    </div>
                </div>

                <!-- Closing Statement -->
                <div class="text-center bg-blue-50 rounded-lg p-8 border border-blue-200">
                    <p class="text-xl text-blue-900 font-medium leading-relaxed">
                        This dashboard transforms raw student feedback into actionable insights through a systematic, AI-assisted approach. By combining qualitative analysis of student comments with quantitative survey data, it reveals not just what students experienced, but how those experiences connect to academic outcomes—giving you a complete picture to guide meaningful course improvements.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Analysis Memo Overlay Modal -->
    <div id="analysis-memo-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl max-h-[90vh] overflow-y-auto m-4">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">AI Analysis Memo: Grouping Rationales</h2>
                <button id="close-analysis-memo" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="px-6 py-6">
                <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-cog text-indigo-400 w-5 h-5"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-indigo-700">
                                <strong>Grouping Transparency:</strong> This memo provides insights into the specific analytical decisions made by the AI when grouping initial codes into themes, explaining the rationale behind each thematic grouping.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div id="analysis-memo-overlay-content" class="prose max-w-none">
                    <!-- AI analysis memo content will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Executive Summary Overlay Modal -->
    <div id="executive-summary-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl max-h-[90vh] overflow-y-auto m-4">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Executive Summary</h2>
                <button id="close-executive-summary" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="px-6 py-6">
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-chart-line text-blue-400 w-5 h-5"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Strategic Analysis:</strong> This summary provides key insights and actionable recommendations based on student feedback, academic performance data, and quantitative survey results.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div id="executive-summary-overlay-content" class="prose max-w-none">
                    <!-- Executive summary content will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedFiles = {
            comments: null,
            schedule: null,
            grades: null,
            likert: null
        };
        let allComments = [];
        let allThemes = [];
        let currentFilter = 'all';
        let currentSearch = '';
        let currentSection = 'all';
        let processedData = null;
        let currentJobId = null;
        let gradeChart = null;
        
        // Chat state
        let chatHistory = [];
        let isChatOpen = false;
        let isTyping = false;

        // File input handlers
        document.getElementById('comments-file').addEventListener('change', function(e) {
            selectedFiles.comments = e.target.files[0];
            updateFileStatus('comments', selectedFiles.comments);
            updateAnalyzeButton();
        });

        document.getElementById('schedule-file').addEventListener('change', function(e) {
            selectedFiles.schedule = e.target.files[0];
            updateFileStatus('schedule', selectedFiles.schedule);
        });

        document.getElementById('grades-file').addEventListener('change', function(e) {
            selectedFiles.grades = e.target.files[0];
            updateFileStatus('grades', selectedFiles.grades);
        });

        document.getElementById('likert-file').addEventListener('change', function(e) {
            selectedFiles.likert = e.target.files[0];
            updateFileStatus('likert', selectedFiles.likert);
        });

        // Initialize methodology modal on page load
        function initializeMethodologyModal() {
            const howItWorksBtn = document.getElementById('how-it-works-btn');
            const methodologyOverlay = document.getElementById('methodology-overlay');
            const closeMethodology = document.getElementById('close-methodology');

            if (howItWorksBtn) {
                howItWorksBtn.addEventListener('click', () => {
                    methodologyOverlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                });
            }

            if (closeMethodology) {
                closeMethodology.addEventListener('click', () => {
                    methodologyOverlay.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                });
            }

            if (methodologyOverlay) {
                methodologyOverlay.addEventListener('click', (e) => {
                    if (e.target === methodologyOverlay) {
                        methodologyOverlay.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !methodologyOverlay.classList.contains('hidden')) {
                    methodologyOverlay.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Initialize on page load
        initializeMethodologyModal();

        // Section filter handler
        document.getElementById('section-filter').addEventListener('change', function(e) {
            currentSection = e.target.value;
            updateCourseDetails();
            updateGradeChart();
            processThematicSummary(allComments);
            filterComments();
        });

        function updateFileStatus(fileType, file) {
            const statusElement = document.getElementById(`${fileType}-status`);
            if (file) {
                statusElement.innerHTML = `<div class="success">✓ ${file.name}</div>`;
            } else {
                statusElement.innerHTML = '';
            }
        }

        function updateAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            // Only comments file is required
            analyzeBtn.disabled = !selectedFiles.comments;
        }

        // Search functionality with real-time filtering
        document.getElementById('searchInput').addEventListener('input', function(e) {
            currentSearch = e.target.value.toLowerCase();
            filterComments();
        });

        // Demo function with comprehensive demo data
        async function tryDemo() {
            showLoading(true);
            
            // Use our updated mock data directly instead of loading CSV
            setTimeout(() => {
                showLoading(false);
                displayDashboard(generateMockData(), generateDemoExecutiveSummary(), generateDemoAIAnalysisMemo(), generateDemoQuantitativeData());
            }, 2000);
        }

        // Generate comprehensive demo executive summary
        function generateDemoExecutiveSummary() {
            return `# Executive Summary: PSY Course Feedback Analysis

## Overall Summary

Analysis of student feedback, course performance, and survey data reveals a consistent pattern of strong **TA Performance and Support** and effective **Course Content and Relevance** across PSY courses. However, significant challenges emerge regarding **Workload and Course Pacing** and **Assignments and Assessment Design**, particularly in ASU Online and I-Course modalities, which correlate with substantially higher DEW (D, E, W grades) rates. While instructors are generally rated highly, there are specific areas for improvement in assessment design and workload management to improve student success and satisfaction, especially in non-traditional instruction modes.

## Key Strengths

• **TA Performance and Support**: Students consistently praise TAs for their helpfulness and responsiveness. For example, a student from an In-Person section (85255) commented, "The TA made it easy to understand concepts and was helpful in the learning process." This is strongly validated by quantitative surveys, where an unnamed Lab TA in a section (26485) received "above_average" ratings across multiple metrics, including "The Lab TA was helpful in as well as outside the class." (score 5.0 vs. peer average 4.2). Implication: TAs are a highly valued resource and contribute significantly to student comprehension and support.

• **Instructor Teaching Effectiveness**: Instructors are generally well-regarded for making complex concepts understandable and engaging. For instance, a student from Professor Nittler's In-Person section (70286) noted, "Professor Nittler is extremely knowledgable ant teaches complex concepts in a way that is understandable." This aligns with survey data showing Professor Nittler's In-Person section (70286) scoring "above_average" (4.66 vs. peer average 4.13) for "How would you rate the overall effectiveness of the instructor?". Implication: Effective instruction is a key driver of positive student experience and learning.

• **Course Content and Relevance**: Students express appreciation for the interesting and informative nature of the course material. A student from an In-Person section (78601) stated, "Now I understand why so many human behaviors that are experienced often... are the way they are." Similarly, a student from an ASU Online section (73054) appreciated "How informative it was; I learned a lot about psychology and human behavior." Implication: The core subject matter of Psychology courses resonates well with students, providing a strong foundation for engagement.

## Areas for Improvement

• **Workload and Course Pacing**: Many students, especially in online modalities, report feeling overwhelmed by the volume of work. A student from an ASU Online section (73054) commented, "The course load was a lot," and "it burnt me out a couple times." Another student from an I-Course section (23480) highlighted, "The amount of assignments that are expected from a low level course. All of my upper level courses were impacted negatively due to the amount of work this low level course required." Implication: High workload in online/I-Course settings appears to be a significant stressor and potential contributor to disengagement and lower success rates.

• **Assignments and Assessment Design**: There are repeated concerns about the clarity, fairness, and utility of assignments and quizzes. Students from an In-Person section (70286) noted "some of the quizzes have mistakes" and "Not really - just correct quiz answers." In an unnamed section (26512), students specifically disliked "Not being able to see the answers to questions I got incorrect," which prevented them from learning from mistakes. A Hybrid section (10075) student also felt the "class seems to grade based more on work ethic than actual understanding of the material." Implication: Issues with assessment design, including accuracy and feedback mechanisms, can hinder learning and cause student frustration.

• **Instructor Feedback and Responsiveness (select sections)**: While generally positive, some instructors receive lower ratings for providing feedback. An unnamed section (35203) showed "below_average" ratings for "The instructor provided meaningful feedback on graded work." (score 2.77 vs. peer average 3.66) and "The instructor responded to inquiries within 24 hours." (score 3.36 vs. peer average 3.91). Implication: Insufficient or delayed feedback can impede student learning and progress, particularly in remote learning environments where clear communication is paramount.

## Patterns and Comparisons

Modality Impact on DEW Rates: There is a clear correlation between instruction mode and student success. ASU Online and I-Course sections (e.g., 73054 at 24.5% DEW, 23480 at 26.0% DEW, 23481 at 29.2% DEW) consistently exhibit significantly higher DEW rates compared to In-Person sections (e.g., 70286 at 7.2% DEW, 78601 at 5.7% DEW). This suggests that while online modalities offer flexibility, the current design, particularly regarding workload and module pacing (as highlighted by online students in 73054), may pose challenges for student completion. Instructor Effectiveness vs. DEW: Strong instructor effectiveness ratings (e.g., In-Person section 70286 with "above_average" instructor effectiveness and low DEW) tend to correlate with lower DEW rates, suggesting that instructor quality is a protective factor. TA Performance as a Universal Strength: Across all modalities, TA Performance and Support consistently emerges as a strength in qualitative feedback and often receives average or above-average survey ratings, irrespective of the overall course performance or DEW rates.

## Actionable Recommendations

1. **Review and Optimize Workload for Online/I-Course Modalities**: Given the consistently high DEW rates and explicit student feedback on excessive workload in ASU Online (73054, 23481) and I-Course (23480) sections, conduct a thorough audit of assignments, quizzes, and overall pacing. The goal should be to ensure the workload is appropriate for a foundational course, aligns with credit hours, and does not burn out students, thereby potentially reducing DEW rates and improving completion.

2. **Enhance Assessment Design and Feedback Mechanisms**: Address student concerns regarding quiz accuracy, lack of visible correct answers, and general feedback quality in assignments. Implement standardized practices for quiz review to eliminate errors (as suggested by In-Person section 70286 students) and ensure students can review incorrect answers for learning. Furthermore, prioritize comprehensive and timely feedback on graded work, especially in sections (like 35203) where feedback was rated "below_average."

3. **Leverage TA Strengths and Best Practices**: Capitalize on the consistently strong performance of TAs by sharing best practices from highly-rated TAs (like those in section 26485) across the department. Explore how TAs can further support students in challenging areas, such as clarifying assignment expectations and providing more detailed feedback, particularly in online modalities where direct instructor interaction may be limited.`;
        }

        // Generate comprehensive demo AI analysis memo
        function generateDemoAIAnalysisMemo() {
            return `# AI Analysis Memo: Grouping Rationales

## Thematic Analysis Methodology

This memo explains the AI-driven rationale behind grouping student feedback into thematic categories for the Biology course analysis.

### Theme 1: Course Structure and Organization
**Rationale**: Comments addressing syllabus clarity, content organization, timeline management, and overall course design were grouped together. This theme captures how students experience the foundational framework of the course.

**Representative Codes Included**: 
- Organization and grading
- Well-structured content  
- Unclear syllabus expectations

**Analysis**: Students value predictability and clear expectations. When these are missing, it significantly impacts their learning experience.

### Theme 2: Assessment and Grading
**Rationale**: All feedback related to exams, quizzes, grading practices, and evaluation methods were consolidated. This theme focuses specifically on how student learning is measured and communicated.

**Representative Codes Included**:
- Exam difficulty mismatch
- More frequent assessments
- Fair grading and quick feedback

**Analysis**: Assessment alignment emerges as a critical factor - when practice materials don't match exam difficulty, student trust and performance suffer.

### Theme 3: Course Workload and Difficulty
**Rationale**: Comments about assignment volume, timing, academic rigor, and time management challenges were grouped to capture the student experience of academic demands.

**Representative Codes Included**:
- Overwhelming workload timing
- Better assignment distribution

**Analysis**: The issue isn't necessarily the amount of work, but rather the coordination and timing of major deliverables.

### Theme 4: Instructor Performance and Engagement  
**Rationale**: Feedback specifically about instructor teaching methods, communication style, accessibility, and classroom presence formed this distinct category.

**Representative Codes Included**:
- Engaging instructor explanations
- Fast pacing through complex material

**Analysis**: Students respond strongly to instructor engagement but need adequate time to process complex concepts.

### Theme 5: Course Content and Materials
**Rationale**: Comments about textbooks, resources, lab activities, and curriculum relevance were grouped to focus on the substance of what students are learning.

**Representative Codes Included**:
- Effective lab activities
- Outdated textbook materials

**Analysis**: Hands-on activities are highly valued, while outdated materials create disconnect between learning and application.

### Theme 6: Learning Support and Resources
**Rationale**: Feedback about office hours, TA support, study resources, and academic assistance were consolidated to capture the support ecosystem around learning.

**Representative Codes Included**:
- Helpful office hours and TA
- Need more practice problems

**Analysis**: When support is accessible and proactive, it significantly enhances student success and satisfaction.

### Theme 7: Course Delivery and Technology
**Rationale**: Comments specifically about online platforms, hybrid format effectiveness, and technology integration challenges formed this distinct category.

**Representative Codes Included**:
- Effective hybrid format
- Technical platform issues
- Clearer format communication

**Analysis**: Technology serves learning best when it's invisible - problems emerge when technical issues disrupt the educational experience.

## Quality Assurance Notes

- **Code Coverage**: 100% of student comments were successfully assigned to themes
- **Theme Coherence**: Each theme maintained internal consistency while remaining distinct from others
- **Validation Method**: Cross-referenced with quantitative survey data where available
- **Bias Mitigation**: Ensured equal representation of positive, negative, and neutral sentiment across themes`;
        }

        // Generate demo quantitative survey data based on real analysis
        function generateDemoQuantitativeData() {
            return {
                sections: {
                    "73054": { // PSY 101 - ASU Online section
                        questions: {
                            "Course Effort Required": {
                                "question_text": "Relative to other courses you have taken, the amount of effort required to succeed in this course was",
                                "this_section_score": 3.7,
                                "peer_group_average": 3.88,
                                "deviation": -0.18,
                                "student_count": 74,
                                "response_distribution": {"5": 13, "4": 32, "3": 24, "2": 4, "1": 1}
                            },
                            "Overall Course Rating": {
                                "question_text": "How would you rate the course as a whole?",
                                "this_section_score": 4.44,
                                "peer_group_average": 3.83,
                                "deviation": 0.61,
                                "student_count": 73,
                                "response_distribution": {"5": 42, "4": 23, "3": 6, "2": 2, "1": 0}
                            },
                            "Course Criteria Clear": {
                                "question_text": "The course criteria for success on graded work was clear and specific",
                                "this_section_score": 4.41,
                                "peer_group_average": 4.13,
                                "deviation": 0.28,
                                "student_count": 74,
                                "response_distribution": {"5": 41, "4": 26, "3": 5, "2": 0, "1": 2}
                            },
                            "Course Navigation": {
                                "question_text": "The course was easy to navigate",
                                "this_section_score": 4.34,
                                "peer_group_average": 4.15,
                                "deviation": 0.19,
                                "student_count": 74,
                                "response_distribution": {"5": 40, "4": 27, "3": 2, "2": 2, "1": 3}
                            }
                        }
                    },
                    "70286": { // PSY 102 - In-Person section  
                        questions: {
                            "TA Helpfulness": {
                                "question_text": "The Lab TA was helpful in as well as outside the class",
                                "this_section_score": 5.0,
                                "peer_group_average": 4.2,
                                "deviation": 0.8,
                                "student_count": 70,
                                "response_distribution": {"5": 45, "4": 18, "3": 5, "2": 2, "1": 0}
                            },
                            "Instructor Effectiveness": {
                                "question_text": "How would you rate the overall effectiveness of the instructor?",
                                "this_section_score": 4.66,
                                "peer_group_average": 4.13,
                                "deviation": 0.53,
                                "student_count": 70,
                                "response_distribution": {"5": 38, "4": 22, "3": 8, "2": 2, "1": 0}
                            }
                        }
                    },
                    "35203": { // PSY 103 - ASU Online section
                        questions: {
                            "Meaningful Feedback": {
                                "question_text": "The instructor provided meaningful feedback on graded work",
                                "this_section_score": 2.77,
                                "peer_group_average": 3.66,
                                "deviation": -0.89,
                                "student_count": 75,
                                "response_distribution": {"5": 8, "4": 12, "3": 25, "2": 18, "1": 12}
                            },
                            "Response Time": {
                                "question_text": "The instructor responded to inquiries within 24 hours",
                                "this_section_score": 3.36,
                                "peer_group_average": 3.91,
                                "deviation": -0.55,
                                "student_count": 70,
                                "response_distribution": {"5": 15, "4": 22, "3": 20, "2": 8, "1": 5}
                            }
                        }
                    }
                }
            };
        }

        // WebSocket connection for progress updates
        let progressWebSocket = null;

        // Main analyze function with real-time progress tracking
        async function analyzeFiles() {
            if (!selectedFiles.comments) {
                alert('Please select a Student Comments file first (required).');
                return;
            }

            try {
                // Step 1: Start the analysis and get job ID
                const formData = new FormData();
                formData.append('comments_file', selectedFiles.comments);
                
                if (selectedFiles.schedule) {
                    formData.append('schedule_file', selectedFiles.schedule);
                }
                
                if (selectedFiles.grades) {
                    formData.append('grades_file', selectedFiles.grades);
                }
                
                if (selectedFiles.likert) {
                    formData.append('likert_file', selectedFiles.likert);
                }

                const response = await fetch('/api/v2/analyze-with-progress', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.statusText}`);
                }

                const startData = await response.json();
                currentJobId = startData.job_id;
                
                console.log('Analysis started with job ID:', currentJobId);

                // Step 2: Show progress tracker and connect WebSocket
                showProgressTracker();
                connectProgressWebSocket(currentJobId);

            } catch (error) {
                console.error('Error starting analysis:', error);
                alert(`Error starting analysis: ${error.message}. Please try again.`);
            }
        }

        function showProgressTracker() {
            // Hide upload section and show progress tracker
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('progress-tracker').style.display = 'block';
            
            // Show quantitative step if Likert file is uploaded
            if (selectedFiles.likert) {
                document.getElementById('step-quantitative').classList.remove('hidden');
            }
            
            // Reset all progress steps to pending
            resetProgressSteps();
        }

        function resetProgressSteps() {
            const steps = ['cleaning', 'quantitative', 'coding', 'themes', 'summary'];
            steps.forEach(step => {
                const icon = document.getElementById(`icon-${step}`);
                icon.className = 'step-icon pending';
                
                const connector = document.getElementById(`connector-${step}`);
                if (connector) {
                    connector.className = 'step-connector';
                }
                
                // Reset batch progress
                const batchProgress = document.getElementById(`batch-progress-${step}`);
                if (batchProgress) {
                    batchProgress.classList.add('hidden');
                    const batchBar = document.getElementById(`batch-bar-${step}`);
                    if (batchBar) {
                        batchBar.style.width = '0%';
                    }
                }
                
                            // Reset batch summary (keep container visible but clear text)
            const batchSummary = document.getElementById(`batch-summary-${step}`);
            const batchSummaryText = document.getElementById(`batch-summary-text-${step}`);
            if (batchSummary) {
                batchSummary.style.visibility = 'visible';
            }
            if (batchSummaryText) {
                batchSummaryText.textContent = '';
                batchSummaryText.style.opacity = '0';
            }
            
            // Show default animation when resetting
            const defaultAnimation = document.getElementById('default-animation');
            if (defaultAnimation) {
                defaultAnimation.style.display = 'block';
            }
            });
        }

        function connectProgressWebSocket(jobId) {
            // Use WebSocket (ws://) for local development, wss:// for production
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/progress/${jobId}`;
            
            console.log('Connecting to WebSocket:', wsUrl);
            
            progressWebSocket = new WebSocket(wsUrl);
            
            progressWebSocket.onopen = function(event) {
                console.log('WebSocket connected for job:', jobId);
            };
            
            progressWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Progress update:', data);
                
                if (data.stage === 'results') {
                    // Analysis complete - display results
                    handleAnalysisComplete(data.data);
                } else if (data.stage === 'error') {
                    // Handle error
                    handleAnalysisError(data.message);
                } else if (data.status === 'batch_summary') {
                    // Handle batch summary (ephemeral display)
                    updateBatchSummary(data.stage, data.message);
                } else {
                    // Update progress step
                    updateProgressStep(data.stage, data.status, data.message);
                }
            };
            
            progressWebSocket.onclose = function(event) {
                console.log('WebSocket closed');
            };
            
            progressWebSocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                handleAnalysisError('Connection error during analysis');
            };
        }

        function updateProgressStep(stage, status, message) {
            const icon = document.getElementById(`icon-${stage}`);
            const messageEl = document.getElementById(`msg-${stage}`);
            const connector = document.getElementById(`connector-${stage}`);
            const batchProgress = document.getElementById(`batch-progress-${stage}`);
            
            if (icon) {
                // Update icon status
                icon.className = `step-icon ${status}`;
                
                // Update icon for completed steps
                if (status === 'complete') {
                    icon.innerHTML = '<i class="fas fa-check"></i>';
                    if (connector) {
                        connector.className = 'step-connector active';
                    }
                    // Hide batch progress and summary when complete, show default animation
                    if (batchProgress) {
                        batchProgress.classList.add('hidden');
                    }
                    const batchSummary = document.getElementById(`batch-summary-${stage}`);
                    if (batchSummary) {
                        batchSummary.style.visibility = 'hidden';
                    }
                    const defaultAnimation = document.getElementById('default-animation');
                    if (defaultAnimation) {
                        defaultAnimation.style.display = 'block';
                    }
                } else if (status === 'in_progress') {
                    // Keep original icon for in_progress
                    const originalIcons = {
                        'cleaning': 'fa-broom',
                        'quantitative': 'fa-chart-bar',
                        'coding': 'fa-tags', 
                        'themes': 'fa-lightbulb',
                        'summary': 'fa-file-alt'
                    };
                    icon.innerHTML = `<i class="fas ${originalIcons[stage]}"></i>`;
                    
                    // Show batch progress for applicable stages and check if message contains batch info
                    console.log('Checking batch progress:', { stage, message, hasBatchProgress: !!batchProgress, includesBatch: message?.includes('batch') });
                    if (batchProgress && message && message.includes('batch')) {
                        console.log('Calling updateBatchProgress for:', stage, message);
                        updateBatchProgress(stage, message);
                    }
                } else if (status === 'error') {
                    icon.innerHTML = '<i class="fas fa-times"></i>';
                    // Hide batch progress and summary on error, show default animation
                    if (batchProgress) {
                        batchProgress.classList.add('hidden');
                    }
                    const batchSummary = document.getElementById(`batch-summary-${stage}`);
                    if (batchSummary) {
                        batchSummary.style.visibility = 'hidden';
                    }
                    const defaultAnimation = document.getElementById('default-animation');
                    if (defaultAnimation) {
                        defaultAnimation.style.display = 'block';
                    }
                }
            }
            
            if (messageEl && message) {
                // Don't show batch details in main message if it's a batch update
                if (message && message.includes('batch') && batchProgress) {
                    // Don't update the message element for batch updates - let the central area handle it
                    return;
                } else {
                    messageEl.textContent = message;
                }
            }
        }

        function updateBatchProgress(stage, message) {
            console.log('updateBatchProgress called:', stage, message);
            
            const batchProgress = document.getElementById(`batch-progress-${stage}`);
            const batchText = document.getElementById(`batch-text-${stage}`);
            const batchBar = document.getElementById(`batch-bar-${stage}`);
            const defaultAnimation = document.getElementById('default-animation');
            
            console.log('Elements found:', {
                batchProgress: !!batchProgress,
                batchText: !!batchText,
                batchBar: !!batchBar
            });
            
            if (!batchProgress || !batchText || !batchBar) {
                console.log('Missing elements for batch progress');
                return;
            }
            
            // Show the batch progress and hide default animation
            batchProgress.classList.remove('hidden');
            if (defaultAnimation) {
                defaultAnimation.style.display = 'none';
            }
            console.log('Batch progress shown');
            
            // Extract percentage from message like "Processing batch 2 of 5 (40%)"
            const percentMatch = message.match(/\((\d+)%\)/);
            const batchMatch = message.match(/batch (\d+) of (\d+)/);
            
            console.log('Regex matches:', { percentMatch, batchMatch });
            
            if (percentMatch && batchMatch) {
                const percentage = parseInt(percentMatch[1]);
                const currentBatch = batchMatch[1];
                const totalBatches = batchMatch[2];
                
                console.log('Updating progress:', { percentage, currentBatch, totalBatches });
                
                // Update text
                batchText.textContent = `Batch ${currentBatch} of ${totalBatches}`;
                
                // Update progress bar
                batchBar.style.width = `${percentage}%`;
                
                console.log('Progress updated successfully');
            } else if (message.includes('Completed all')) {
                // Handle completion message
                batchText.textContent = 'All batches completed';
                batchBar.style.width = '100%';
                
                console.log('Completion message handled');
                
                // Hide after a short delay
                setTimeout(() => {
                    batchProgress.classList.add('hidden');
                }, 1500);
            } else {
                console.log('Message format not recognized');
            }
        }

        function updateBatchSummary(stage, message) {
            console.log('updateBatchSummary called:', stage, message);
            
            const batchSummary = document.getElementById(`batch-summary-${stage}`);
            const batchSummaryText = document.getElementById(`batch-summary-text-${stage}`);
            const defaultAnimation = document.getElementById('default-animation');
            
            if (!batchSummary || !batchSummaryText) {
                console.log('Batch summary elements not found for stage:', stage);
                return;
            }
            
            // Hide default animation when showing batch summary
            if (defaultAnimation) {
                defaultAnimation.style.display = 'none';
            }
            
            // Clean up the message (remove emoji if present)
            const cleanMessage = message.replace(/💭\s*/, '').trim();
            
            // Ensure the container is visible (it's now always visible but content fades in/out)
            batchSummary.style.visibility = 'visible';
            
            // Update the text with smooth fade transition
            batchSummaryText.style.opacity = '0';
            setTimeout(() => {
                batchSummaryText.textContent = cleanMessage;
                batchSummaryText.style.opacity = '1';
            }, 150);
            
            // Fade out text after 4 seconds (but keep container visible)
            setTimeout(() => {
                batchSummaryText.style.opacity = '0';
            }, 4000);
        }

        function handleAnalysisComplete(analysisData) {
            console.log('Analysis complete:', analysisData);
            
            // Store the job ID for downloading
            currentJobId = analysisData.jobId;
            
            // Store processed data
            processedData = {
                dashboardData: analysisData.dashboardData,
                markdownReport: analysisData.markdownReport,
                executiveSummary: analysisData.executiveSummary,
                quantitativeAnalysis: analysisData.quantitativeAnalysis,
                jobId: analysisData.jobId
            };
            
            // Check for validation warnings and display them
            if (analysisData.validationResults) {
                displayValidationAlerts(analysisData.validationResults);
            }
            
            // Hide progress tracker and show dashboard
            document.getElementById('progress-tracker').style.display = 'none';
            
            // Use the dashboard data directly from the API response
            if (analysisData.dashboardData && analysisData.dashboardData.length > 0) {
                displayDashboard(analysisData.dashboardData, analysisData.executiveSummary, analysisData.aiAnalysisMemo, analysisData.quantitativeAnalysis);
            } else {
                throw new Error('No dashboard data generated');
            }
            
            // Close WebSocket connection
            if (progressWebSocket) {
                progressWebSocket.close();
                progressWebSocket = null;
            }
        }

        function handleAnalysisError(errorMessage) {
            console.error('Analysis error:', errorMessage);
            
            // Show error state in UI
            document.getElementById('progress-tracker').style.display = 'none';
            document.getElementById('upload-section').style.display = 'block';
            
            alert(`Analysis failed: ${errorMessage}. Please try again.`);
            
            // Close WebSocket connection
            if (progressWebSocket) {
                progressWebSocket.close();
                progressWebSocket = null;
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, ''));
            
            return lines.slice(1).map(line => {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                return obj;
            });
        }

        function generateMockData() {
            return [
                // TA Performance and Support (26 comments, 76.9% positive)
                {
                    question: "What did you like the most about the course?",
                    response: "The TA made it easy to understand concepts and was helpful in the learning process.",
                    Initial_Code: "Helpful and responsive TA",
                    Sentiment: "Positive",
                    Theme: "TA Performance and Support",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "73054",
                    Instructor: "Dr. Williams",
                    "Instruction Mode": "ASU Online",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "265",
                    A: 45, B: 78, C: 67, D: 35, E: 25, W: 15
                },
                {
                    question: "What did you like the most about the course?",
                    response: "The Lab TA was extremely helpful both in class and during office hours.",
                    Initial_Code: "Exceptional lab TA support",
                    Sentiment: "Positive",
                    Theme: "TA Performance and Support",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "26485",
                    Instructor: "Dr. Davis",
                    "Instruction Mode": "In-Person",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "75",
                    A: 28, B: 25, C: 15, D: 4, E: 2, W: 1
                },
                {
                    question: "What did you like the most about the course?",
                    response: "TA was always available to help and made complex topics much clearer.",
                    Initial_Code: "Always available helpful TA",
                    Sentiment: "Positive",
                    Theme: "TA Performance and Support",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "26485",
                    Instructor: "Dr. Davis",
                    "Instruction Mode": "In-Person",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "75",
                    A: 28, B: 25, C: 15, D: 4, E: 2, W: 1
                },
                
                // Assignments and Assessment Design (17 comments, 70.6% negative)
                {
                    question: "What suggestions do you have for improving this course?",
                    response: "Not being able to see the answers to questions I got incorrect prevented me from learning from mistakes.",
                    Initial_Code: "Cannot review incorrect answers",
                    Sentiment: "Negative",
                    Theme: "Assignments and Assessment Design",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "73054",
                    Instructor: "Dr. Williams",
                    "Instruction Mode": "ASU Online",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "265",
                    A: 45, B: 78, C: 67, D: 35, E: 25, W: 15
                },
                {
                    question: "What did you like the least about the course?",
                    response: "Some of the quizzes have mistakes in them.",
                    Initial_Code: "Quiz errors and mistakes",
                    Sentiment: "Negative",
                    Theme: "Assignments and Assessment Design",
                    crs_number: "PSY 102",
                    SectionNumber_ASU: "70286",
                    Instructor: "Professor Nittler",
                    "Instruction Mode": "In-Person",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "95",
                    A: 38, B: 32, C: 18, D: 4, E: 2, W: 1
                },
                {
                    question: "What suggestions do you have for improving this course?",
                    response: "Class seems to grade based more on work ethic than actual understanding of the material.",
                    Initial_Code: "Grading based on effort not understanding",
                    Sentiment: "Negative",
                    Theme: "Assignments and Assessment Design",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "23480",
                    Instructor: "Dr. Martinez",
                    "Instruction Mode": "I-Course",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "180",
                    A: 32, B: 45, C: 38, D: 25, E: 18, W: 22
                },
                {
                    question: "What suggestions do you have for improving this course?",
                    response: "Not really - just correct quiz answers.",
                    Initial_Code: "Fix quiz answer keys",
                    Sentiment: "Neutral",
                    Theme: "Assignments and Assessment Design",
                    crs_number: "PSY 102",
                    SectionNumber_ASU: "70286",
                    Instructor: "Professor Nittler",
                    "Instruction Mode": "In-Person",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "95",
                    A: 38, B: 32, C: 18, D: 4, E: 2, W: 1
                },
                
                // Overall Course Impressions (17 comments, 76.5% positive)
                {
                    question: "What did you like the most about the course?",
                    response: "How informative it was; I learned a lot about psychology and human behavior.",
                    Initial_Code: "Informative psychology content",
                    Sentiment: "Positive",
                    Theme: "Overall Course Impressions",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "73054",
                    Instructor: "Dr. Williams",
                    "Instruction Mode": "ASU Online",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "265",
                    A: 45, B: 78, C: 67, D: 35, E: 25, W: 15
                },
                {
                    question: "What did you like the most about the course?",
                    response: "The course content was fascinating and really opened my eyes to human behavior and cognition.",
                    Initial_Code: "Fascinating course content",
                    Sentiment: "Positive",
                    Theme: "Overall Course Impressions",
                    crs_number: "PSY 102",
                    SectionNumber_ASU: "70286",
                    Instructor: "Professor Nittler",
                    "Instruction Mode": "In-Person",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "95",
                    A: 38, B: 32, C: 18, D: 4, E: 2, W: 1
                },
                
                // Course Content and Relevance (13 comments, 76.9% positive)
                {
                    question: "What did you like the most about the course?",
                    response: "Now I understand why so many human behaviors that are experienced often... are the way they are.",
                    Initial_Code: "Understanding real-world applications",
                    Sentiment: "Positive",
                    Theme: "Course Content and Relevance",
                    crs_number: "PSY 102",
                    SectionNumber_ASU: "78601",
                    Instructor: "Dr. Thompson",
                    "Instruction Mode": "In-Person",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "88",
                    A: 35, B: 28, C: 20, D: 3, E: 1, W: 1
                },
                {
                    question: "What did you like the most about the course?",
                    response: "The content about cognitive psychology and memory was really engaging.",
                    Initial_Code: "Engaging cognitive content",
                    Sentiment: "Positive",
                    Theme: "Course Content and Relevance",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "73054",
                    Instructor: "Dr. Williams",
                    "Instruction Mode": "ASU Online",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "265",
                    A: 45, B: 78, C: 67, D: 35, E: 25, W: 15
                },
                
                // Workload and Course Pacing (8 comments, 75% negative)  
                {
                    question: "What did you like the least about the course?",
                    response: "The course load was a lot, it burnt me out a couple times.",
                    Initial_Code: "Excessive workload causing burnout",
                    Sentiment: "Negative",
                    Theme: "Workload and Course Pacing",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "73054",
                    Instructor: "Dr. Williams",
                    "Instruction Mode": "ASU Online",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "265",
                    A: 45, B: 78, C: 67, D: 35, E: 25, W: 15
                },
                {
                    question: "What did you like the least about the course?",
                    response: "The amount of assignments that are expected from a low level course. All of my upper level courses were impacted negatively due to the amount of work this low level course required.",
                    Initial_Code: "Excessive workload for intro course",
                    Sentiment: "Negative",
                    Theme: "Workload and Course Pacing",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "23480",
                    Instructor: "Dr. Martinez",
                    "Instruction Mode": "I-Course",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "180",
                    A: 32, B: 45, C: 38, D: 25, E: 18, W: 22
                },
                
                // Instructor Teaching Effectiveness (7 comments, 57.1% positive)
                {
                    question: "What did you like the most about the course?",
                    response: "Professor Nittler is extremely knowledgeable and teaches complex psychological concepts in a way that is understandable.",
                    Initial_Code: "Knowledgeable instructor clear explanations",
                    Sentiment: "Positive",
                    Theme: "Instructor Teaching Effectiveness",
                    crs_number: "PSY 102",
                    SectionNumber_ASU: "70286",
                    Instructor: "Professor Nittler",
                    "Instruction Mode": "In-Person",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "95",
                    A: 38, B: 32, C: 18, D: 4, E: 2, W: 1
                },
                {
                    question: "What did you like the least about the course?",
                    response: "The instructor rarely provided meaningful feedback on our assignments.",
                    Initial_Code: "Lack of meaningful feedback",
                    Sentiment: "Negative",
                    Theme: "Instructor Teaching Effectiveness",
                    crs_number: "PSY 103",
                    SectionNumber_ASU: "35203",
                    Instructor: "Dr. Roberts",
                    "Instruction Mode": "ASU Online",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "145",
                    A: 25, B: 35, C: 42, D: 22, E: 12, W: 9
                },
                {
                    question: "What suggestions do you have for improving this course?",
                    response: "Instructor should respond to emails and questions more quickly.",
                    Initial_Code: "Slow instructor response time",
                    Sentiment: "Negative",
                    Theme: "Instructor Teaching Effectiveness",
                    crs_number: "PSY 103",
                    SectionNumber_ASU: "35203",
                    Instructor: "Dr. Roberts",
                    "Instruction Mode": "ASU Online",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "145",
                    A: 25, B: 35, C: 42, D: 22, E: 12, W: 9
                },
                
                                // Learning Modalities and Resources (5 comments, 80% positive)
                {
                    question: "What did you like the most about the course?",
                    response: "The online learning platform was easy to navigate and well-organized.",
                    Initial_Code: "User-friendly platform",
                    Sentiment: "Positive",
                    Theme: "Learning Modalities and Resources",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "73054",
                    Instructor: "Dr. Williams",
                    "Instruction Mode": "ASU Online",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "265",
                    A: 45, B: 78, C: 67, D: 35, E: 25, W: 15
                },
                
                // Course Structure and Organization (4 comments, 50% positive)
                {
                    question: "What suggestions do you have for improving this course?",
                    response: "Better organization of course materials would be helpful.",
                    Initial_Code: "Need better organization",
                    Sentiment: "Neutral",
                    Theme: "Course Structure and Organization",
                    crs_number: "PSY 101",
                    SectionNumber_ASU: "73054",
                    Instructor: "Dr. Williams",
                    "Instruction Mode": "ASU Online",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "265",
                    A: 45, B: 78, C: 67, D: 35, E: 25, W: 15
                },
                {
                    question: "What did you like the most about the course?",
                    response: "Well-structured syllabus and clear expectations from the beginning.",
                    Initial_Code: "Clear structure and expectations",
                    Sentiment: "Positive",
                    Theme: "Course Structure and Organization",
                    crs_number: "PSY 102",
                    SectionNumber_ASU: "78601",
                    Instructor: "Dr. Thompson",
                    "Instruction Mode": "In-Person",
                    "Term/Session": "Fall 23 C",
                    "Total Enrollment": "88",
                    A: 35, B: 28, C: 20, D: 3, E: 1, W: 1
                }
            ];
        }

        function displayDashboard(data, executiveSummary, aiAnalysisMemo = '', quantitativeAnalysis = null) {
            allComments = data;
            
            // Process and display all components
            processStats(data);
            populateSectionFilter(data);
            populateThemeFilters(data);
            displayComments(data);
            renderExecutiveSummary(executiveSummary);
            renderAIAnalysisMemo(aiAnalysisMemo, currentJobId);
            updateCourseDetails();
            updateGradeChart();
            renderQuantitativeResults(quantitativeAnalysis);
            setupInteractivity();
            
            // Hide upload section and show dashboard
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            
            // Show chat FAB when dashboard is ready
            showChatFab();
        }

        function populateSectionFilter(data) {
            const sections = [...new Set(data.map(d => d.SectionNumber_ASU).filter(s => s))];
            const sectionFilter = document.getElementById('section-filter');
            
            // Clear existing options except "All Sections"
            sectionFilter.innerHTML = '<option value="all">All Sections</option>';
            
            // Add section options with detailed information
            sections.forEach(section => {
                // Find the first record for this section to get details
                const sectionData = data.find(d => String(d.SectionNumber_ASU) === String(section));
                
                if (sectionData) {
                    // Extract details with fallback options for different column name variations
                    const course = sectionData.crs_number || sectionData.Course || sectionData['Course Number'] || 'Unknown Course';
                    const instructor = sectionData['Instructor(s)'] || sectionData['Primary Instructor'] || sectionData.Instructor || 'Unknown Instructor';
                    const modality = sectionData['Instruction Mode'] || sectionData.Location || sectionData.Modality || 'Unknown Modality';
                    
                    // Check if this is a lab section - look for "Lab" in various fields
                    const isLab = (
                        (sectionData.Session && sectionData.Session.toLowerCase().includes('lab')) ||
                        (sectionData.Course && sectionData.Course.toLowerCase().includes('lab')) ||
                        (sectionData['Course Title'] && sectionData['Course Title'].toLowerCase().includes('lab')) ||
                        (sectionData.crs_number && sectionData.crs_number.toString().toLowerCase().includes('lab'))
                    );
                    
                    // Build the label: Course - Section - Modality [- Lab] (Instructor hidden)
                    // HIDDEN: let label = `${course} - ${section} - ${instructor} - ${modality}`;
                    let label = `${course} - ${section} - ${modality}`;
                    if (isLab) {
                        label += ' - Lab';
                    }
                    
                    const option = document.createElement('option');
                    option.value = section;
                    option.textContent = label;
                    sectionFilter.appendChild(option);
                } else {
                    // Fallback if no data found
                    const option = document.createElement('option');
                    option.value = section;
                    option.textContent = `Section ${section}`;
                    sectionFilter.appendChild(option);
                }
            });
        }

        function updateCourseDetails() {
            // Show blank values when "All Sections" is selected
            if (currentSection === 'all') {
                // HIDDEN: document.getElementById('detail-instructor').textContent = '-';
                document.getElementById('detail-modality').textContent = '-';
                document.getElementById('detail-term').textContent = '-';
                document.getElementById('detail-enrollment').textContent = '-';
                return;
            }
            
            let data = allComments;
            
            // Filter by selected section with type conversion
            data = data.filter(d => {
                const commentSection = String(d.SectionNumber_ASU);
                const selectedSection = String(currentSection);
                return commentSection === selectedSection;
            });
            
            if (data.length === 0) {
                // HIDDEN: document.getElementById('detail-instructor').textContent = '-';
                document.getElementById('detail-modality').textContent = '-';
                document.getElementById('detail-term').textContent = '-';
                document.getElementById('detail-enrollment').textContent = '-';
                return;
            }
            
            // Get details from first record (assuming consistency within section)
            const sample = data[0];
            
            // Map to correct column names from merged data
            // HIDDEN: const instructor = sample['Instructor(s)'] || sample['Primary Instructor'] || sample.Instructor || '-';
            const modality = sample['Instruction Mode'] || sample.Location || sample.Modality || '-';
            const term = sample['Term/Session'] || sample.Dates || sample.Term || '-';
            const enrollment = sample['Total Enrollment'] || sample.Enrollment || '-';
            
            // HIDDEN: document.getElementById('detail-instructor').textContent = instructor;
            document.getElementById('detail-modality').textContent = modality;
            document.getElementById('detail-term').textContent = term;
            document.getElementById('detail-enrollment').textContent = enrollment;
        }

        function updateGradeChart() {
            let data = allComments;
            
            // Filter by selected section if not "all" with type conversion
            if (currentSection !== 'all') {
                data = data.filter(d => {
                    const commentSection = String(d.SectionNumber_ASU);
                    const selectedSection = String(currentSection);
                    return commentSection === selectedSection;
                });
            }
            
            // Check if grade data exists - look for individual grade columns
            const gradesExist = data.some(d => d.A || d.B || d.C || d.D || d.E || d.W);
            
            if (!gradesExist) {
                document.getElementById('gradeChart').style.display = 'none';
                document.getElementById('no-grade-data').classList.remove('hidden');
                document.getElementById('dew-stats').classList.add('hidden');
                return;
            }
            
            document.getElementById('gradeChart').style.display = 'block';
            document.getElementById('no-grade-data').classList.add('hidden');
            
            // Count grades from individual columns (A, B, C, D, E, W from grades file)
            const gradeCounts = {
                A: 0, B: 0, C: 0, D: 0, E: 0, W: 0
            };
            
            if (currentSection === 'all') {
                // When showing all sections, aggregate across unique sections to avoid double counting
                const uniqueSections = [...new Set(data.map(d => d.SectionNumber_ASU))];
                uniqueSections.forEach(section => {
                    const sectionData = data.filter(d => String(d.SectionNumber_ASU) === String(section))[0];
                    if (sectionData) {
                        gradeCounts.A += parseInt(sectionData.A) || 0;
                        gradeCounts.B += parseInt(sectionData.B) || 0;
                        gradeCounts.C += parseInt(sectionData.C) || 0;
                        gradeCounts.D += parseInt(sectionData.D) || 0;
                        gradeCounts.E += parseInt(sectionData.E) || 0;
                        gradeCounts.W += parseInt(sectionData.W) || 0;
                    }
                });
            } else {
                // When filtering by specific section, just use that section's data
                const sectionData = data[0]; // data is already filtered by section
                if (sectionData) {
                    gradeCounts.A = parseInt(sectionData.A) || 0;
                    gradeCounts.B = parseInt(sectionData.B) || 0;
                    gradeCounts.C = parseInt(sectionData.C) || 0;
                    gradeCounts.D = parseInt(sectionData.D) || 0;
                    gradeCounts.E = parseInt(sectionData.E) || 0;
                    gradeCounts.W = parseInt(sectionData.W) || 0;
                }
            }
            
            // Destroy existing chart if it exists
            if (gradeChart) {
                gradeChart.destroy();
            }
            
            // Calculate DEW statistics
            const dewCount = gradeCounts.D + gradeCounts.E + gradeCounts.W;
            const totalGraded = Object.values(gradeCounts).reduce((sum, count) => sum + count, 0);
            
            // Display DEW statistics
            const dewStatsElement = document.getElementById('dew-stats');
            if (dewCount > 0 && totalGraded > 0) {
                const dewPercentage = ((dewCount / totalGraded) * 100).toFixed(1);
                const dewBreakdown = `D${gradeCounts.D}, E${gradeCounts.E}, W${gradeCounts.W}`;
                
                document.getElementById('dew-percentage').textContent = `${dewPercentage}% (${dewCount}/${totalGraded})`;
                document.getElementById('dew-breakdown').textContent = dewBreakdown;
                dewStatsElement.classList.remove('hidden');
            } else {
                dewStatsElement.classList.add('hidden');
            }
            
            // Create new chart
            const ctx = document.getElementById('gradeChart').getContext('2d');
            gradeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['A', 'B', 'C', 'D', 'E', 'W'],
                    datasets: [{
                        label: 'Number of Students',
                        data: ['A', 'B', 'C', 'D', 'E', 'W'].map(grade => gradeCounts[grade] || 0),
                        backgroundColor: [
                            '#10b981', '#3b82f6', '#f59e0b', '#f97316', '#ef4444', '#6b7280'
                        ],
                        borderColor: [
                            '#059669', '#2563eb', '#d97706', '#ea580c', '#dc2626', '#4b5563'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function processStats(data) {
            const themes = [...new Set(data.map(d => d.Theme).filter(t => t && t !== 'Unmapped'))];
            
            // Update basic stats
            document.getElementById('total-comments').textContent = data.length;
            document.getElementById('total-themes').textContent = themes.length;
            
            // Process thematic summary
            processThematicSummary(data);
        }
        
        function processThematicSummary(data) {
            // Filter by selected section if not "all"
            let filteredData = data;
            if (currentSection !== 'all') {
                filteredData = data.filter(d => {
                    const commentSection = String(d.SectionNumber_ASU);
                    const selectedSection = String(currentSection);
                    return commentSection === selectedSection;
                });
            }
            
            // Group data by theme and analyze sentiment
            const themeAnalysis = {};
            
            filteredData.forEach(comment => {
                const theme = comment.Theme;
                const sentiment = comment.Sentiment;
                
                if (theme && theme !== 'Unmapped') {
                    if (!themeAnalysis[theme]) {
                        themeAnalysis[theme] = {
                            total: 0,
                            positive: 0,
                            negative: 0,
                            neutral: 0
                        };
                    }
                    
                    themeAnalysis[theme].total++;
                    
                    if (sentiment === 'Positive') {
                        themeAnalysis[theme].positive++;
                    } else if (sentiment === 'Negative') {
                        themeAnalysis[theme].negative++;
                    } else {
                        themeAnalysis[theme].neutral++;
                    }
                }
            });
            
            // Sort themes by total comments (descending)
            const sortedThemes = Object.entries(themeAnalysis)
                .sort(([,a], [,b]) => b.total - a.total);
            
            // Generate HTML for thematic summary
            const summaryContainer = document.getElementById('thematic-summary');
            
            if (sortedThemes.length === 0) {
                summaryContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No themed comments available</p>';
                return;
            }
            
            summaryContainer.innerHTML = sortedThemes.map(([theme, stats]) => {
                const positivePercent = stats.total > 0 ? (stats.positive / stats.total * 100).toFixed(1) : 0;
                const negativePercent = stats.total > 0 ? (stats.negative / stats.total * 100).toFixed(1) : 0;
                const neutralPercent = stats.total > 0 ? (stats.neutral / stats.total * 100).toFixed(1) : 0;
                
                return `
                    <div class="mb-4 p-3 border border-gray-200 rounded-lg bg-gray-50">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-800 text-sm leading-tight">${theme}</h4>
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">${stats.total}</span>
                        </div>
                        
                        <!-- Sentiment breakdown -->
                        <div class="space-y-1">
                            ${stats.positive > 0 ? `
                                <div class="flex items-center justify-between text-xs">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                        <span class="text-gray-600">Positive</span>
                                    </div>
                                    <span class="font-medium text-green-700">${positivePercent}% (${stats.positive})</span>
                                </div>
                            ` : ''}
                            
                            ${stats.negative > 0 ? `
                                <div class="flex items-center justify-between text-xs">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                                        <span class="text-gray-600">Negative</span>
                                    </div>
                                    <span class="font-medium text-red-700">${negativePercent}% (${stats.negative})</span>
                                </div>
                            ` : ''}
                            
                            ${stats.neutral > 0 ? `
                                <div class="flex items-center justify-between text-xs">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-gray-400 rounded-full mr-2"></div>
                                        <span class="text-gray-600">Neutral</span>
                                    </div>
                                    <span class="font-medium text-gray-700">${neutralPercent}% (${stats.neutral})</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Visual sentiment bar -->
                        <div class="mt-2 flex rounded-full overflow-hidden h-2">
                            ${stats.positive > 0 ? `<div class="bg-green-500" style="width: ${positivePercent}%"></div>` : ''}
                            ${stats.negative > 0 ? `<div class="bg-red-500" style="width: ${negativePercent}%"></div>` : ''}
                            ${stats.neutral > 0 ? `<div class="bg-gray-400" style="width: ${neutralPercent}%"></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateThemeFilters(data) {
            const themes = [...new Set(data.map(d => d.Theme).filter(t => t && t !== 'Unmapped'))];
            allThemes = themes;
            
            const filtersContainer = document.getElementById('theme-filters');
            // Keep the "All Themes" button and add theme buttons
            const existingButtons = filtersContainer.innerHTML;
            const themeButtons = themes.map(theme => 
                `<button class="theme-button px-4 py-2 rounded-full font-semibold text-sm transition bg-gray-100 text-gray-700 hover:bg-gray-200" onclick="filterByTheme('${theme}')">${theme}</button>`
            ).join('');
            
            filtersContainer.innerHTML = existingButtons + themeButtons;
        }

        function renderExecutiveSummary(executiveSummary) {
            const executiveSummaryContent = document.getElementById('executive-summary-overlay-content');
            
            if (typeof executiveSummary === 'string' && executiveSummary.trim()) {
                // Use marked.js to parse the markdown executive summary
                try {
                    const htmlContent = marked.parse(executiveSummary);
                    executiveSummaryContent.innerHTML = `<div class="executive-summary-content">${htmlContent}</div>`;
                } catch (error) {
                    console.warn('Markdown parsing failed, using plain text:', error);
                    executiveSummaryContent.innerHTML = `<div class="executive-summary-content">${executiveSummary.replace(/\n/g, '<br>')}</div>`;
                }
            } else {
                // Fallback to theme-based takeaways if no executive summary is available
                const themeGroups = allComments.reduce((acc, comment) => {
                    const theme = comment.Theme;
                    if (theme && theme !== 'Unmapped') {
                        if (!acc[theme]) {
                            acc[theme] = {
                                codes: new Set(),
                                description: getThemeDescription(theme)
                            };
                        }
                        if (comment.Initial_Code) {
                            acc[theme].codes.add(comment.Initial_Code);
                        }
                    }
                    return acc;
                }, {});

                executiveSummaryContent.innerHTML = `
                    <h3>Thematic Analysis Summary</h3>
                    <p><em>Executive summary generation is unavailable. Here's a thematic breakdown:</em></p>
                    ${Object.entries(themeGroups).map(([theme, info]) => `
                        <h4>${theme}</h4>
                        <p>${info.description}</p>
                        <ul>
                            ${Array.from(info.codes).slice(0, 5).map(code => `<li>${code}</li>`).join('')}
                            ${info.codes.size > 5 ? `<li><em>...and ${info.codes.size - 5} more codes</em></li>` : ''}
                        </ul>
                    `).join('')}
                `;
            }
        }

        function getThemeDescription(theme) {
            const descriptions = {
                "Instructor Performance and Engagement": "Concerns the students' perception of the instructor's involvement, accessibility, and feedback quality.",
                "Course Workload and Difficulty": "Feedback related to the amount and difficulty of coursework assignments.",
                "Course Content and Materials": "Student opinions on the quality and relevance of course materials and content.",
                "Lab Experiences": "Specific feedback about laboratory components and activities.",
                "Course Structure and Organization": "Comments about how the course is organized and structured.",
                "Teaching Assistant (TA) Performance and Support": "Feedback regarding teaching assistants' effectiveness and support.",
                "Online Platforms and Tools": "Issues and feedback about online learning platforms and tools used.",
                "Overall Course Enjoyment and Effectiveness": "General sentiments about the overall course experience.",
                "Student Peer Interactions": "Comments about interactions with other students in the course."
            };
            return descriptions[theme] || "Student feedback related to this aspect of the course.";
        }

        function displayComments(comments) {
            const container = document.getElementById('comments-container');
            
            if (comments.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No comments match your current filters.</p>';
                return;
            }
            
            container.innerHTML = comments.map(comment => `
                <div class="comment-card border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <p class="font-semibold text-gray-600 mb-2">${comment.question || 'Question not available'}</p>
                    <p class="text-gray-800 italic mb-3">"${comment.response || 'Response not available'}"</p>
                    <div class="flex flex-wrap items-center gap-2 text-xs font-medium">
                        <span class="px-2 py-1 rounded-full ${getSentimentStyle(comment.Sentiment)}">
                            <i class="fas ${getSentimentIcon(comment.Sentiment)} mr-1"></i>${comment.Sentiment || 'Neutral'}
                        </span>
                        ${comment.Theme && comment.Theme !== 'Unmapped' ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${comment.Theme}</span>` : ''}
                        ${comment.Initial_Code ? `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${comment.Initial_Code}</span>` : ''}
                        ${comment.crs_number ? `<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${comment.crs_number}</span>` : ''}
                        ${comment.SectionNumber_ASU ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">Section ${comment.SectionNumber_ASU}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getSentimentStyle(sentiment) {
            switch(sentiment) {
                case 'Positive': return 'bg-green-100 text-green-800';
                case 'Negative': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getSentimentIcon(sentiment) {
            switch(sentiment) {
                case 'Positive': return 'fa-thumbs-up';
                case 'Negative': return 'fa-thumbs-down';
                default: return 'fa-minus';
            }
        }

        function filterByTheme(theme) {
            currentFilter = theme;
            
            // Update button states
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterComments();
        }

        function filterComments() {
            let filtered = allComments;
            
            // Apply section filter with type conversion
            if (currentSection !== 'all') {
                filtered = filtered.filter(comment => {
                    // Convert both to strings for comparison to handle type mismatches
                    const commentSection = String(comment.SectionNumber_ASU);
                    const selectedSection = String(currentSection);
                    return commentSection === selectedSection;
                });
            }
            
            // Apply theme filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(comment => comment.Theme === currentFilter);
            }
            
            // Apply search filter
            if (currentSearch) {
                filtered = filtered.filter(comment => 
                    (comment.response && comment.response.toLowerCase().includes(currentSearch)) ||
                    (comment.question && comment.question.toLowerCase().includes(currentSearch)) ||
                    (comment.Theme && comment.Theme.toLowerCase().includes(currentSearch)) ||
                    (comment.Initial_Code && comment.Initial_Code.toLowerCase().includes(currentSearch))
                );
            }
            
            displayComments(filtered);
        }

        function setupInteractivity() {
            // Executive Summary modal
            const executiveSummaryBtn = document.getElementById('executive-summary-btn');
            const executiveSummaryOverlay = document.getElementById('executive-summary-overlay');
            const closeExecutiveSummary = document.getElementById('close-executive-summary');

            if (executiveSummaryBtn) {
                executiveSummaryBtn.addEventListener('click', () => {
                    executiveSummaryOverlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                });
            }

            if (closeExecutiveSummary) {
                closeExecutiveSummary.addEventListener('click', () => {
                    executiveSummaryOverlay.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                });
            }

            // Close modal when clicking outside
            if (executiveSummaryOverlay) {
                executiveSummaryOverlay.addEventListener('click', (e) => {
                    if (e.target === executiveSummaryOverlay) {
                        executiveSummaryOverlay.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }
                });
            }

            // Thematic takeaways toggle (remove since Executive Summary moved to modal)
            // AI Analysis Memo modal
            const analysisMemoBtn = document.getElementById('analysis-memo-btn');
            const analysisMemoBtn2 = document.getElementById('analysis-memo-btn-thematic');
            const analysisMemoOverlay = document.getElementById('analysis-memo-overlay');
            const closeAnalysisMemo = document.getElementById('close-analysis-memo');

            if (analysisMemoBtn) {
                analysisMemoBtn.addEventListener('click', () => {
                    analysisMemoOverlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                });
            }

            if (analysisMemoBtn2) {
                analysisMemoBtn2.addEventListener('click', () => {
                    analysisMemoOverlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                });
            }

            if (closeAnalysisMemo) {
                closeAnalysisMemo.addEventListener('click', () => {
                    analysisMemoOverlay.classList.add('hidden');
                    document.body.style.overflow = 'auto'; // Restore scrolling
                });
            }

            // Close modal when clicking outside
            if (analysisMemoOverlay) {
                analysisMemoOverlay.addEventListener('click', (e) => {
                    if (e.target === analysisMemoOverlay) {
                        analysisMemoOverlay.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }
                });
            }



            // Close analysis memo modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const executiveSummaryOverlay = document.getElementById('executive-summary-overlay');
                    const analysisMemoOverlay = document.getElementById('analysis-memo-overlay');
                    
                    if (!executiveSummaryOverlay.classList.contains('hidden')) {
                        executiveSummaryOverlay.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    } else if (!analysisMemoOverlay.classList.contains('hidden')) {
                        analysisMemoOverlay.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }
                }
            });
        }

        function renderAIAnalysisMemo(aiAnalysisMemo, jobId = null) {
            const analysisMemoOverlayContent = document.getElementById('analysis-memo-overlay-content');
            const analysisMemoBtn = document.getElementById('analysis-memo-btn');
            const analysisMemoBtn2 = document.getElementById('analysis-memo-btn-thematic');
            
            if (typeof aiAnalysisMemo === 'string' && aiAnalysisMemo.trim()) {
                // Show the analysis memo buttons
                if (analysisMemoBtn) {
                    analysisMemoBtn.style.display = 'inline-block';
                }
                if (analysisMemoBtn2) {
                    analysisMemoBtn2.style.display = 'inline-block';
                }
                
                // Clean and format the analysis memo text
                const cleanMemo = aiAnalysisMemo.trim();
                
                // Convert markdown-style formatting to HTML
                let formattedMemo = cleanMemo
                    .replace(/^# (.+)$/gm, '<h2 class="text-xl font-bold text-gray-900 mb-4">$1</h2>')
                    .replace(/^## (.+)$/gm, '<h3 class="text-lg font-semibold text-gray-800 mb-3">$1</h3>')
                    .replace(/^\*\*Analysis ID:\*\* (.+)$/gm, '<p class="text-sm text-gray-600 font-mono mb-4"><strong>Analysis ID:</strong> $1</p>')
                    .replace(/\*\*AI Grouping Rationale:\*\* "(.+)"/gm, '<div class="bg-gray-50 border-l-4 border-indigo-400 p-3 mb-4"><p class="text-gray-700 italic">"$1"</p></div>')
                    .split('\n\n')
                    .filter(paragraph => paragraph.trim())
                    .map(paragraph => {
                        const trimmedParagraph = paragraph.trim();
                        // Don't wrap already formatted elements
                        if (trimmedParagraph.startsWith('<h') || trimmedParagraph.startsWith('<div') || trimmedParagraph.startsWith('<p class="text-sm')) {
                            return trimmedParagraph;
                        }
                        return `<p class="mb-3 text-gray-700">${trimmedParagraph}</p>`;
                    })
                    .join('');
                
                analysisMemoOverlayContent.innerHTML = formattedMemo || '<p class="text-gray-500 italic">No grouping rationale memo provided.</p>';
                
                console.log('AI Analysis Memo rendered:', cleanMemo.substring(0, 100) + '...');
            } else {
                // Hide the analysis memo buttons if no memo is available
                if (analysisMemoBtn) {
                    analysisMemoBtn.style.display = 'none';
                }
                if (analysisMemoBtn2) {
                    analysisMemoBtn2.style.display = 'none';
                }
                console.log('No AI analysis memo available');
            }
        }



        async function downloadThemedCSV() {
            if (!currentJobId) {
                alert('No analysis data available to download.');
                return;
            }
            
            try {
                const response = await fetch(`/api/v2/download/${currentJobId}`);
                
                if (!response.ok) {
                    throw new Error('Download failed');
                }
                
                // Get the filename from the Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'themed_analysis.csv';
                if (contentDisposition) {
                    const matches = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading file. Please try again.');
            }
        }

        function displayValidationAlerts(validationResults) {
            // Clear any existing alerts
            const existingAlerts = document.querySelectorAll('.validation-alert');
            existingAlerts.forEach(alert => alert.remove());

            validationResults.forEach(result => {
                if (result.result.status === 'warning' && result.result.type === 'time_period_mismatch') {
                    displayTimePeroidMismatchAlert(result.file_type, result.result);
                } else if (result.result.status === 'error') {
                    displayErrorAlert(result.file_type, result.result);
                }
            });
        }

        function displayTimePeroidMismatchAlert(fileType, result) {
            const alertHTML = `
                <div class="validation-alert bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">
                                Data Time Period Mismatch - ${fileType.charAt(0).toUpperCase() + fileType.slice(1)} File
                            </h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p>${result.message}</p>
                                <div class="mt-2">
                                    <p><strong>Details:</strong></p>
                                    <ul class="list-disc list-inside ml-4">
                                        <li>Comments sections: ${result.details.comments_sections}</li>
                                        <li>${fileType} sections: ${result.details[fileType === 'schedule' ? 'schedule_sections' : 'grades_sections']}</li>
                                        <li>Overlapping sections: ${result.details.overlapping_sections}</li>
                                        <li>Overlap percentage: ${result.details.overlap_percentage.toFixed(1)}%</li>
                                    </ul>
                                </div>
                                <div class="mt-3 p-3 bg-yellow-100 rounded">
                                    <p class="text-sm font-medium text-yellow-800">
                                        ⚠️ Recommendation: Please verify that all uploaded files are from the same academic term/year.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert alert at the top of the dashboard
            const dashboard = document.getElementById('dashboard-content');
            dashboard.insertAdjacentHTML('afterbegin', alertHTML);
        }

        function displayErrorAlert(fileType, result) {
            const alertHTML = `
                <div class="validation-alert bg-red-50 border-l-4 border-red-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-times-circle text-red-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">
                                Error Processing ${fileType.charAt(0).toUpperCase() + fileType.slice(1)} File
                            </h3>
                            <div class="mt-2 text-sm text-red-700">
                                <p>${result.message}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert alert at the top of the dashboard
            const dashboard = document.getElementById('dashboard-content');
            dashboard.insertAdjacentHTML('afterbegin', alertHTML);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            if (!show) {
                document.getElementById('upload-section').style.display = 'none';
            }
        }

        // Quantitative Results Functions
        function renderQuantitativeResults(quantitativeAnalysis) {
            // Render quantitative analysis results
            
            const container = document.getElementById('quantitative-results-container');
            const chartsWrapper = document.getElementById('quantitative-charts-wrapper');
            const noDataDiv = document.getElementById('no-quantitative-data');
            
            console.log('Quantitative container elements found:', {
                container: !!container,
                chartsWrapper: !!chartsWrapper,
                noDataDiv: !!noDataDiv
            });
            
            if (!quantitativeAnalysis || !quantitativeAnalysis.sections) {
                console.log('No quantitative analysis or sections found, hiding container');
                container.classList.add('hidden');
                return;
            }
            
            // Process quantitative analysis data
            
            // Show the container and set up toggle functionality
            container.classList.remove('hidden');
            setupQuantitativeToggle();
            
            // Auto-expand the quantitative section when data is available
            const quantitativeContent = document.getElementById('quantitative-content');
            const quantitativeChevron = document.getElementById('quantitative-chevron');
            if (quantitativeContent && quantitativeChevron) {
                quantitativeContent.classList.remove('hidden');
                quantitativeChevron.style.transform = 'rotate(180deg)';
            }
            
            // Store globally for section filtering
            window.quantitativeAnalysis = quantitativeAnalysis;
            
            // Initial render based on current section
            updateQuantitativeDisplay();
        }

        function setupQuantitativeToggle() {
            const toggleBtn = document.getElementById('toggle-quantitative');
            const content = document.getElementById('quantitative-content');
            const chevron = document.getElementById('quantitative-chevron');
            
            toggleBtn.addEventListener('click', function() {
                const isHidden = content.classList.contains('hidden');
                
                if (isHidden) {
                    content.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    content.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
            });
        }

        function updateQuantitativeDisplay() {
            if (!window.quantitativeAnalysis) return;
            
            const chartsWrapper = document.getElementById('quantitative-charts-wrapper');
            const noDataDiv = document.getElementById('no-quantitative-data');
            
            // Check if a specific section is selected
            if (currentSection === 'all') {
                chartsWrapper.style.display = 'none';
                noDataDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-hand-pointer text-3xl mb-3"></i>
                        <p class="text-lg font-medium">Select a specific section to view quantitative survey results</p>
                        <p class="text-sm">Use the section filter above to choose a course section.</p>
                    </div>
                `;
                noDataDiv.classList.remove('hidden');
                return;
            }
            
            // Find data for current section
            const sectionData = window.quantitativeAnalysis.sections[currentSection];
            
            if (!sectionData || !sectionData.questions || Object.keys(sectionData.questions).length === 0) {
                chartsWrapper.style.display = 'none';
                noDataDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-info-circle text-3xl mb-3"></i>
                        <p class="text-lg">No quantitative survey data available for this section.</p>
                        <p class="text-sm">This section may not have participated in the survey.</p>
                    </div>
                `;
                noDataDiv.classList.remove('hidden');
                return;
            }
            
            // Clear previous charts and show content
            chartsWrapper.innerHTML = '';
            chartsWrapper.style.display = 'block';
            noDataDiv.classList.add('hidden');
            
            // Render compact question summaries for each question
            Object.entries(sectionData.questions).forEach(([questionKey, questionData]) => {
                renderQuestionChart(questionKey, questionData);
            });
        }

        function renderQuestionChart(questionKey, questionData) {
            const chartDiv = document.createElement('div');
            chartDiv.className = 'question-chart bg-gray-50 rounded-lg border border-gray-200';
            
            // Use actual question text from backend if available, otherwise derive from key
            const questionText = questionData.question_text || 
                questionKey
                    .replace(/^q_/, '')
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
            
            const hasDeviation = questionData.deviation !== null && Math.abs(questionData.deviation) > 0.3;
            const deviationClass = hasDeviation ? 
                (questionData.deviation > 0 ? 'text-green-600' : 'text-red-600') : 
                'text-gray-600';
            
            const uniqueId = `question-${questionKey.replace(/[^a-zA-Z0-9]/g, '')}`;
            
            chartDiv.innerHTML = `
                <div class="p-4">
                    <h4 class="text-base font-semibold text-gray-800 mb-3">${questionText}</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                        <div>
                            <span class="text-gray-600">This Section:</span>
                            <div class="font-semibold ${hasDeviation && questionData.deviation < 0 ? 'text-red-600' : hasDeviation ? 'text-green-600' : 'text-gray-800'}">
                                ${questionData.this_section_score}/5
                            </div>
                        </div>
                        <div>
                            <span class="text-gray-600">Peer Average:</span>
                            <div class="font-semibold text-blue-600">
                                ${questionData.peer_group_average !== null ? questionData.peer_group_average + '/5' : 'N/A'}
                            </div>
                        </div>
                        <div>
                            <span class="text-gray-600">Difference:</span>
                            <div class="font-semibold ${deviationClass}">
                                ${questionData.peer_group_average !== null ? 
                                    (questionData.deviation > 0 ? '+' : '') + questionData.deviation : 
                                    'Unique'}
                            </div>
                        </div>
                        <div>
                            <span class="text-gray-600">Responses:</span>
                            <div class="font-semibold text-gray-800">${questionData.student_count}</div>
                        </div>
                    </div>
                    
                    <!-- Toggle button for response distribution -->
                    <button 
                        onclick="toggleResponseDistribution('${uniqueId}')" 
                        class="mt-3 text-sm text-indigo-600 hover:text-indigo-800 flex items-center">
                        <i id="${uniqueId}-chevron" class="fas fa-chevron-right mr-1 transition-transform"></i>
                        View Response Distribution
                    </button>
                </div>
                
                <!-- Collapsible response distribution -->
                <div id="${uniqueId}-distribution" class="hidden border-t border-gray-200 bg-white">
                    <div class="p-4">
                        <h5 class="text-sm font-medium text-gray-700 mb-3">Response Distribution:</h5>
                        <div class="space-y-2" style="max-height: 200px; overflow-y: auto;">
                            ${createDistributionBars(questionData.response_distribution, questionData.student_count, questionData.response_labels)}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('quantitative-charts-wrapper').appendChild(chartDiv);
        }

        function createDistributionBars(distribution, totalResponses, responseLabels) {
            // Debug: Log the distribution data to console
            // Distribution data successfully parsed from backend
            
            const responses = ['5', '4', '3', '2', '1'];
            
            // Use backend-provided response labels if available, otherwise default to Likert scale
            const defaultLabels = {
                '5': 'Strongly Agree',
                '4': 'Agree', 
                '3': 'Neutral',
                '2': 'Disagree',
                '1': 'Strongly Disagree'
            };
            const labels = responseLabels || defaultLabels;
            
            const colors = {
                '5': 'bg-green-500',
                '4': 'bg-green-300',
                '3': 'bg-gray-400',
                '2': 'bg-red-300', 
                '1': 'bg-red-500'
            };
            
            const distributionHTML = responses.map(score => {
                // Handle backend string keys that are formatted as "5.0", "4.0", etc.
                const stringKey = score;                           // "5"
                const stringKeyWithDecimal = score + ".0";         // "5.0"  
                const intKey = parseInt(score);                    // 5
                const floatKey = parseFloat(score);                // 5.0
                
                const count = distribution[stringKey] || 
                             distribution[stringKeyWithDecimal] || 
                             distribution[intKey] || 
                             distribution[floatKey] || 0;
                             
                const percentage = totalResponses > 0 ? (count / totalResponses * 100) : 0;
                
                // Note: Backend sends distribution keys as "5.0", "4.0", etc.
                
                return `
                    <div class="flex items-center">
                        <div class="w-32 text-sm text-gray-600 text-right pr-3">
                            ${labels[score] || score}
                        </div>
                        <div class="flex-1 bg-gray-200 rounded-full h-6 relative">
                            <div class="${colors[score]} h-6 rounded-full flex items-center justify-end pr-2" 
                                 style="width: ${Math.max(percentage, count > 0 ? 8 : 0)}%">
                                ${count > 0 ? `<span class="text-white text-xs font-medium">${count}</span>` : ''}
                            </div>
                        </div>
                        <div class="w-12 text-sm text-gray-600 text-right pl-2">
                            ${percentage.toFixed(0)}%
                        </div>
                    </div>
                `;
            }).join('');
            
            return distributionHTML;
        }

        function toggleResponseDistribution(uniqueId) {
            const distributionDiv = document.getElementById(`${uniqueId}-distribution`);
            const chevron = document.getElementById(`${uniqueId}-chevron`);
            
            if (distributionDiv.classList.contains('hidden')) {
                distributionDiv.classList.remove('hidden');
                chevron.style.transform = 'rotate(90deg)';
            } else {
                distributionDiv.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // Update section filter to also update quantitative display
        const originalSectionFilterHandler = document.getElementById('section-filter').onchange;
        document.getElementById('section-filter').addEventListener('change', function() {
            updateQuantitativeDisplay();
        });

        // =================
        // CHATBOT FUNCTIONS
        // =================

        // Toggle chat panel visibility
        function toggleChat() {
            const chatPanel = document.getElementById('chat-panel');
            const chatFab = document.getElementById('chat-fab');
            
            isChatOpen = !isChatOpen;
            
            if (isChatOpen) {
                chatPanel.classList.add('open');
                chatFab.classList.add('chat-open');
                // Focus on input when opening
                setTimeout(() => {
                    document.getElementById('chat-input').focus();
                }, 300);
            } else {
                chatPanel.classList.remove('open');
                chatFab.classList.remove('chat-open');
            }
        }

        // Show chat FAB when analysis is complete
        function showChatFab() {
            const chatFab = document.getElementById('chat-fab');
            if (currentJobId) {
                chatFab.style.display = 'flex';
                // Initialize draggable functionality when chat becomes available
                makeDraggable();
                // Ensure send button is properly bound
                setupSendButton();
            }
        }

        // Setup send button event listener
        function setupSendButton() {
            const sendButton = document.getElementById('send-button');
            if (sendButton) {
                // Remove any existing listeners and add new one
                sendButton.removeEventListener('click', handleSendMessage);
                sendButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleSendMessage();
                });
            }
        }

        // Handle Enter key in chat input
        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleSendMessage();
            }
        }

        // Enable/disable send button based on input
        document.getElementById('chat-input').addEventListener('input', function() {
            const input = this.value.trim();
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = !input || isTyping;
        });

        // Make chat panel draggable
        function makeDraggable() {
            const chatPanel = document.getElementById('chat-panel');
            const chatHeader = chatPanel.querySelector('.chat-header');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            function dragStart(e) {
                if (e.target.closest('button')) return; // Don't drag when clicking buttons
                
                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }

                if (e.target === chatHeader || chatHeader.contains(e.target)) {
                    isDragging = true;
                    chatPanel.style.cursor = 'grabbing';
                }
            }

            function dragEnd(e) {
                isDragging = false;
                chatPanel.style.cursor = 'move';
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    if (e.type === "touchmove") {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }

                    xOffset = currentX;
                    yOffset = currentY;

                    // Keep panel within viewport bounds
                    const rect = chatPanel.getBoundingClientRect();
                    const maxX = window.innerWidth - rect.width;
                    const maxY = window.innerHeight - rect.height;
                    
                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));
                    
                    chatPanel.style.transform = `translate(${currentX}px, ${currentY}px) scale(1)`;
                    chatPanel.style.right = 'auto';
                    chatPanel.style.left = '0';
                    chatPanel.style.top = '0';
                }
            }

            chatHeader.addEventListener("mousedown", dragStart);
            document.addEventListener("mouseup", dragEnd);
            document.addEventListener("mousemove", drag);

            chatHeader.addEventListener("touchstart", dragStart);
            document.addEventListener("touchend", dragEnd);
            document.addEventListener("touchmove", drag);
        }

        // Main chat message handler
        async function handleSendMessage() {
            const chatInput = document.getElementById('chat-input');
            const userMessage = chatInput.value.trim();
            
            if (!userMessage || isTyping || !currentJobId) {
                return;
            }

            // Clear input and disable send button
            chatInput.value = '';
            document.getElementById('send-button').disabled = true;
            
            // Add user message to chat history and display
            const userMessageObj = {
                role: 'user',
                content: userMessage,
                timestamp: new Date().toISOString()
            };
            
            chatHistory.push(userMessageObj);
            renderChat();
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Send request to chat API
                const response = await fetch('/api/v2/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        message: userMessage,
                        chat_history: chatHistory.slice(-10) // Send last 10 messages for context
                    }),
                });

                if (!response.ok) {
                    throw new Error(`Chat service error: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Add assistant response to chat history and display
                chatHistory.push(data.response);
                renderChat();
                
            } catch (error) {
                console.error('Chat error:', error);
                
                // Add error message to chat
                const errorMessage = {
                    role: 'assistant',
                    content: '❌ Sorry, I encountered an error processing your message. Please try again.',
                    timestamp: new Date().toISOString()
                };
                
                chatHistory.push(errorMessage);
                renderChat();
            } finally {
                hideTypingIndicator();
            }
        }

        // Render chat messages
        function renderChat() {
            const chatMessages = document.getElementById('chat-messages');
            
            // Keep welcome message and add chat history
            const welcomeMessage = chatMessages.querySelector('.chat-message');
            chatMessages.innerHTML = '';
            
            // Re-add welcome message if no chat history
            if (chatHistory.length === 0 && welcomeMessage) {
                chatMessages.appendChild(welcomeMessage);
            }
            
            // Render chat history
            chatHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${message.role}`;
                
                // Render markdown for assistant responses, plain text for user messages
                let messageContent;
                if (message.role === 'assistant') {
                    // Use marked.js to render markdown
                    messageContent = marked.parse(message.content);
                } else {
                    // For user messages, just convert newlines to breaks
                    messageContent = message.content.replace(/\n/g, '<br>');
                }
                
                messageDiv.innerHTML = `
                    <div class="message-bubble ${message.role}">
                        <div class="text-sm">${messageContent}</div>
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
            });
            
            // Auto-scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            isTyping = true;
            
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message typing-indicator';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="message-bubble assistant">
                    <div class="typing-indicator">
                                                 <span>Analyzing data</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            isTyping = false;
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            
            // Re-enable send button if there's text in input
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = !chatInput.value.trim();
        }
    </script>

    <!-- Chatbot UI -->
    <!-- Floating Action Button -->
    <div class="chat-fab" id="chat-fab" onclick="toggleChat()" style="display: none;">
        <i class="fas fa-comments text-white text-xl"></i>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chat-panel">
        <div class="chat-header">
            <div class="flex items-center">
                <i class="fas fa-robot mr-3 text-lg"></i>
                <div>
                    <h3 class="font-semibold text-sm">Data Assistant</h3>
                    <p class="text-xs opacity-80">Ask me about your data</p>
                </div>
            </div>
            <button onclick="toggleChat()" class="ml-auto text-white hover:bg-white hover:bg-opacity-20 rounded p-1">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <!-- Welcome message -->
            <div class="chat-message">
                <div class="message-bubble assistant">
                    <div class="text-sm">
                        <strong>👋 Hi! I'm your data analyst.</strong><br><br>
                        I can help you explore your student feedback data. Try asking me:
                        <ul class="mt-2 ml-4 text-xs space-y-1">
                            <li>• "What are the main themes?"</li>
                            <li>• "Which section had the highest DEW rate?"</li>
                            <li>• "What did students say about workload?"</li>
                            <li>• "Compare online vs in-person sections"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div style="display: flex; align-items: end; gap: 8px;">
                <textarea 
                    id="chat-input" 
                    class="chat-input" 
                    placeholder="Ask me about your data..."
                    rows="1"
                    onkeydown="handleChatKeypress(event)"
                    style="flex: 1; margin: 0;"
                ></textarea>
                <button 
                    id="send-button" 
                    class="send-button" 
                    type="button"
                    disabled
                >
                    Send
                </button>
            </div>
        </div>
    </div>
</body>
</html> 